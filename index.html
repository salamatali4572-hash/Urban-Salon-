<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Salon Manager Pro (Salamat Ali) - With Offer Code</title>
<style>
/* --- CSS --- */
:root {
    --primary-blue: #1877f2; 
    --light-bg: #f0f2f5;    
    --card-bg: #ffffff;
    --text-color: #050505;
    --border-color: #dddfe2;
    --success-green: #38a169;
    --danger-red: #fa383e;
    --instagram: #E4405F;
    --facebook: #1877F2;
    --whatsapp: #25D366;
    --discount-purple: #9b59b6; /* New color for discount */
}
body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--light-bg);
    color: var(--text-color);
}
header {
    background: var(--card-bg);
    color: var(--primary-blue);
    padding: 15px 20px;
    text-align: center;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    position: sticky;
    top: 0;
    z-index: 1000;
}
header h1 {
    margin: 0;
    font-size: 24px;
}
nav {
    background: var(--card-bg);
    padding: 0;
    display: flex;
    overflow-x: auto;
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 15px;
}
nav button {
    flex-shrink: 0;
    padding: 12px 15px;
    background: transparent;
    border: none;
    color: #606770;
    cursor: pointer;
    transition: background 0.3s, color 0.3s;
    font-size: 14px;
    border-bottom: 2px solid transparent;
}
nav button.action {
    background: var(--primary-blue);
    color: white;
    margin-left: auto;
    border-radius: 6px;
    margin-right: 15px;
}
nav button.active {
    color: var(--primary-blue);
    border-bottom: 2px solid var(--primary-blue);
    background: var(--light-bg);
}
nav button:not(.active):hover:not(.action) {
    background: #f0f2f5;
    color: var(--text-color);
}
section {
    padding: 20px;
    display: none;
    max-width: 800px;
    margin: 20px auto;
}
section.active {
    display: block;
    background: var(--card-bg);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}
h2 {
    color: var(--primary-blue);
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 10px;
    margin-top: 0;
    font-size: 20px;
}
h3 {
    color: #606770;
}
input, select {
    padding: 10px;
    margin: 8px 0;
    width: calc(100% - 20px);
    box-sizing: border-box;
    border: 1px solid var(--border-color);
    background: var(--card-bg);
    color: var(--text-color);
    border-radius: 6px;
}
button.action {
    padding: 10px 18px;
    margin-top: 10px;
    background: var(--primary-blue);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.2s;
}
button.action:hover {
    background: #1660b4;
}
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    border-radius: 8px;
    overflow: hidden;
}
th, td {
    border: 1px solid var(--border-color);
    padding: 12px 10px;
    text-align: left;
}
th {
    background: var(--light-bg);
    color: #606770;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 12px;
}
.row-actions button {
    padding: 5px 10px;
    background: var(--danger-red); 
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    margin-left: 5px;
}
.row-actions .share-btn {
    background: var(--success-green); 
}
.row-actions .share-btn:hover {
    background: #128c7e;
}

/* Appointment Status Styling */
.status-select {
    padding: 5px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--card-bg);
    width: 100%;
}
.delete-btn {
    background: var(--danger-red);
    color: white;
    padding: 5px 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
}
.delete-btn:hover {
    background: #c9302c;
}

/* Resend Button */
.resend-btn {
    background: var(--whatsapp);
    color: white;
    padding: 5px 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    margin-right: 5px;
}
.resend-btn:hover {
    background: #128c7e;
}

/* --- Other Sections CSS --- */
.hidden { display: none !important; }
.scrollable-feed {
    display: flex;
    flex-direction: column;
    gap: 15px;
    max-height: 70vh; 
    overflow-y: auto;
    padding-right: 5px; 
}
.feed-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    display: flex;
    gap: 15px;
    align-items: center;
}
.feed-image {
    width: 80px;
    height: 80px;
    border-radius: 4px;
    object-fit: cover;
    border: 1px solid var(--border-color);
    flex-shrink: 0;
}
.feed-actions {
    flex-shrink: 0;
    display: flex; 
    gap: 5px;
    flex-direction: column;
}

/* --- BILL RECEIPT CONTAINER --- */
#billReceipt {
    padding: 20px;
    background: white;
    border: 2px solid var(--primary-blue);
    margin-bottom: 15px;
    border-radius: 8px;
    font-family: 'Arial', sans-serif;
    font-size: 14px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
#billReceipt h3, #billReceipt table {
    margin: 5px 0;
}
#billReceipt h3 {
    text-align: center;
    color: var(--primary-blue);
    border-bottom: 2px solid var(--primary-blue);
    padding-bottom: 10px;
}
#billReceipt table {
    width: 100%;
    margin: 10px 0;
}
#billReceipt th, #billReceipt td {
    padding: 8px 0;
    border: none;
    border-bottom: 1px solid #eee;
    font-size: 14px;
    vertical-align: top;
}
#billReceipt th {
    background: none;
    color: var(--primary-blue);
    font-weight: bold;
}
.branding-footer {
    text-align: center;
    margin-top: 20px;
    padding-top: 10px;
    border-top: 1px dashed #ccc;
    font-size: 12px;
    color: #666;
}

/* Share Modal Styles */
.share-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 2000;
    align-items: center;
    justify-content: center;
}
.share-modal.active {
    display: flex;
}
.share-modal-content {
    background: white;
    padding: 20px;
    border-radius: 10px;
    max-width: 400px;
    width: 90%;
    text-align: center;
}
.share-platforms {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin: 20px 0;
    flex-wrap: wrap;
}
.share-platform {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    cursor: pointer;
    transition: transform 0.2s;
}
.share-platform:hover {
    transform: scale(1.1);
}
.whatsapp-share { background: var(--whatsapp); }
.facebook-share { background: var(--facebook); }
.instagram-share { background: var(--instagram); }
.copy-share { background: var(--primary-blue); }

.form-row {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}
.form-row input, .form-row select {
    flex: 1;
}
.photo-preview {
    max-width: 100px;
    max-height: 100px;
    margin-top: 10px;
    border-radius: 4px;
}
.auth-link-button {
    background: none;
    border: none;
    color: var(--primary-blue);
    cursor: pointer;
    text-decoration: underline;
    margin: 5px;
}
.loading {
    opacity: 0.7;
    pointer-events: none;
}
.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
}
.status-pending { background: #fff3cd; color: #856404; }
.status-confirmed { background: #d1ecf1; color: #0c5460; }
.status-completed { background: #d4edda; color: #155724; }
.status-cancelled { background: #f8d7da; color: #721c24; }
.receipt-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
    justify-content: center;
}
.receipt-actions button {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
}
.whatsapp-receipt {
    background: var(--whatsapp);
    color: white;
}
.download-receipt {
    background: var(--success-green);
    color: white;
}
.pdf-section {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    border-left: 4px solid var(--primary-blue);
}
</style>

<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

<header>
  <h1> Salon Manager üíá‚Äç‚ôÇÔ∏è</h1>
  <div style="font-size: 10px; color: #666;">
    Powered by Ali (03091539086) &copy;2025
  </div>
</header>

<nav id="mainNav" class="hidden">
  <button onclick="showTab('appointments', this)">Appointments</button>
  <button onclick="showTab('products', this)">Products</button>
  <button onclick="showTab('offers', this)">Offers</button>
  <button onclick="showTab('billing', this)">Billing</button>
  <button onclick="showTab('sales', this)">Sales</button>
  <button onclick="showTab('history', this)">Customers & History</button>
  <button class="action" onclick="showTab('settings', this)" style="background: #6c757d;">Settings ‚öôÔ∏è</button>
  <button class="action" onclick="logoutUser()">Logout</button>
</nav>

<section id="auth" class="active">
  <h2>Access Control</h2>
  <div id="loginForm">
    <h3>Existing User (Login)</h3>
    <input id="logEmail" type="email" placeholder="Email Address" value="salamatali4572@gmail.com">
    <input id="logPass" type="password" placeholder="Password">
    <button class="action" onclick="loginUser()">Login</button>
    <div style="text-align: center; margin-top: 15px;">
        <button class="auth-link-button" onclick="showForgot()">Forgot Password?</button>
        <hr style="border-color:var(--border-color); margin:10px 0;">
        <button class="action" onclick="showRegister()">Register New Account</button>
    </div>
  </div>
  <div id="registerForm" class="hidden">
    <h3>New Account (Register)</h3>
    <input id="regEmail" type="email" placeholder="Email Address">
    <input id="regPass" type="password" placeholder="Password (min 6 chars)">
    <input id="regPin" placeholder="Owner Pin (for admin access)" maxlength="6">
    <button class="action" onclick="registerUser()">Register</button>
    <button class="auth-link-button" onclick="showLogin()">‚Üê Back to Login</button>
  </div>
  <div id="forgotForm" class="hidden">
    <h3>Forgot Password</h3>
    <p>We will send a password reset link to your email.</p>
    <input id="fpEmail" type="email" placeholder="Email Address">
    <button class="action" onclick="forgotPassword()">Send Reset Email</button>
    <button class="auth-link-button" onclick="showLogin()">‚Üê Back to Login</button>
  </div>
</section>

<section id="settings">
    <h2>Salon Settings ‚öôÔ∏è</h2>
    <h3>Business Information</h3>
    <input id="salonNameInput" placeholder="Salon Name (for Receipts)">
    <input id="salonPhoneInput" placeholder="Contact Phone (for Receipts/WhatsApp)">
    <button class="action" onclick="saveSalonInfo()">Save Salon Info</button>
    
    <h3 style="margin-top: 30px;">User Account</h3>
    <p>Your Admin Email: <span id="userEmailDisplay" style="font-weight: bold;"></span></p>
    <button class="action" onclick="promptChangePin()" style="background: #ffc107; color: #000;">Change Owner Pin</button>
</section>

<section id="appointments">
  <h2>Book New Appointment üìÖ</h2>
  <div class="form-row">
    <input id="custName" placeholder="Customer Name">
    <input id="service" placeholder="Service (e.g., Haircut)">
  </div>
  <div class="form-row">
    <input id="apptDate" type="date">
    <input id="apptTime" type="time">
  </div>
  <button class="action" onclick="addAppointment()">Add Appointment</button>
  
  <h3>Upcoming Appointments</h3>
  <table id="apptTable">
    <tr><th>Customer</th><th>Service</th><th>Date</th><th>Time</th><th>Status</th><th>Actions</th></tr> 
  </table>
</section>

<section id="products">
  <h2>Products & Services üõçÔ∏è</h2>
  <div class="form-row">
    <input id="prodName" placeholder="Name">
    <input id="prodPrice" type="number" placeholder="Price">
  </div>
  <div class="form-group">
    <label>Product Image (Optional) - Local Storage</label>
    <input id="prodPhoto" type="file" accept="image/*">
    <img id="prodPhotoPreview" class="photo-preview hidden" src="" alt="Product Preview">
  </div>
  <button class="action" onclick="addProduct()">Add Product/Service</button>
  
  <h3>Current Price List (Scrollable Feed)</h3>
  <div id="prodFeed" class="scrollable-feed">
    </div>
</section>

<section id="offers">
  <h2>Active Offers üéÅ</h2>
  <div class="form-row">
    <input id="offerTitle" placeholder="Offer Title">
    <input id="offerDisc" type="number" placeholder="Discount %">
  </div>
  <input id="offerCode" placeholder="Offer Code (e.g., SUMMER10)" style="width: calc(100% - 20px);"> <div class="form-group">
    <label>Offer Image (Optional) - Local Storage</label>
    <input id="offerPhoto" type="file" accept="image/*">
    <img id="offerPhotoPreview" class="photo-preview hidden" src="" alt="Offer Preview">
  </div>
  <button class="action" onclick="addOffer()">Add New Offer</button>
  
  <h3>Offer List (Scrollable Feed)</h3>
  <div id="offerFeed" class="scrollable-feed">
    </div>
</section>

<section id="billing">
  <h2>Create New Bill üßæ</h2>
  <div class="form-row">
    <input id="billCustName" placeholder="Customer Name" list="customerNames">
    <datalist id="customerNames"></datalist>
    <input id="billCustPhone" placeholder="Customer Phone (for WhatsApp)">
  </div>
  <div class="form-row">
    <select id="billProd"></select>
    <input id="billQty" type="number" value="1" min="1" placeholder="Quantity">
  </div>
  <input id="billOfferCode" placeholder="Apply Offer Code (Optional)" style="width: calc(100% - 20px);"> <button class="action" onclick="addBillItem()">Add Item to Bill</button>
  
  <div id="billReceipt">
    <h3 id="billReceiptHeader">SALON BILL RECEIPT</h3>
    <div style="text-align: center; margin: 10px 0; color: #666; font-size: 12px;">
        Date: <span id="receiptDate"></span>
    </div>
    <div style="margin: 10px 0;">
        <strong>Customer:</strong> <span id="receiptCustomer">Walk-in Customer</span><br>
        <strong>Phone:</strong> <span id="receiptPhone">N/A</span>
    </div>
    <table id="billTable">
      <tr><th>Product</th><th>Qty</th><th>Price</th><th>Total</th></tr>
    </table>
    <h3 style="text-align: right; border-top: 1px dashed #ccc; padding-top: 10px; margin-top: 15px; color:#666; font-size:16px;">
        SUB TOTAL: <span id="billSubTotal" style="color:#666;">0.00</span>
    </h3>
    <h3 style="text-align: right; margin-top: 5px; color:var(--discount-purple); font-size:16px;">
        DISCOUNT (<span id="discountPercent">0%</span>): -<span id="billDiscount">0.00</span> 
    </h3>
    <h3 style="text-align: right; border-top: 2px solid var(--primary-blue); padding-top: 10px; margin-top: 5px; font-size:20px;">
      GRAND TOTAL: <span id="billTotal" style="color:var(--primary-blue);">0.00</span>
    </h3>
    <div class="branding-footer">
        Salon Contact: <span id="brandingPhone">03091539086</span>
        <br>
        Powered by Ali (03091539086) &copy;2025
    </div>
  </div>
  
  <div class="receipt-actions">
    <button class="whatsapp-receipt" onclick="shareReceiptOnWhatsApp()">üì± Send via WhatsApp</button>
    <button class="download-receipt" onclick="downloadReceipt()">üì• Download Receipt</button>
  </div>
  
  <button class="action" onclick="saveBill()" style="margin-top: 15px;">Finalize & Save Bill</button>
</section>

<section id="sales">
  <h2>Sales Report üìà</h2>
  <h3 style="color: var(--primary-blue);">
    Current Month/Day Sales: <span id="totalSales">0.00</span>
  </h3>
  <button class="action" onclick="closeDay()" style="background: var(--success-green);">Close Day & Reset Sales</button>
  
  <div class="pdf-section">
    <h3>üìä Monthly PDF Reports</h3>
    <div class="form-row">
        <select id="pdfMonth">
            <option value="0">January</option>
            <option value="1">February</option>
            <option value="2">March</option>
            <option value="3">April</option>
            <option value="4">May</option>
            <option value="5">June</option>
            <option value="6">July</option>
            <option value="7">August</option>
            <option value="8">September</option>
            <option value="9">October</option>
            <option value="10">November</option>
            <option value="11">December</option>
        </select>
        <select id="pdfYear">
            <option value="2024">2024</option>
            <option value="2025">2025</option>
            <option value="2026">2026</option>
        </select>
    </div>
    <button class="action" onclick="generateMonthlyPDF()" style="background: var(--danger-red);">üìÑ Generate Monthly PDF</button>
    <button class="action" onclick="generateCompletePDF()" style="background: var(--primary-blue);">üìë Generate Complete Report</button>
  </div>

  <h2 style="margin-top: 30px;">Monthly Sales History üí∞</h2>
  <table id="monthlySalesTable">
      <tr><th>Date</th><th>Sales Amount</th></tr>
  </table>
</section>

<section id="history">
  <h2>Customer List üßë‚Äçü§ù‚Äçüßë</h2>
  <div class="form-row" style="gap: 5px; margin-bottom: 15px;">
    <input id="customerSearchInput" placeholder="Search Customer Name" style="flex: 2;">
    <button class="action" onclick="searchCustomer()" style="flex: 1; margin-top: 0; background: #6c757d;">Search üîç</button>
    <button class="action" onclick="promptAddCustomer()" style="flex: 1; margin-top: 0; background: var(--success-green);">Add New +</button>
  </div>
  
  <div id="customerList">
    </div>

  <h2 style="margin-top: 30px;">Transaction History üìú</h2>
  <table id="histTable">
    <tr><th>Customer</th><th>Phone</th><th>Total Bill</th><th>Date</th><th>Actions</th></tr>
  </table>
</section>

<div id="shareModal" class="share-modal">
    <div class="share-modal-content">
        <h3>Share Offer</h3>
        <p id="shareOfferTitle" style="font-weight: bold; margin: 10px 0;"></p>
        <p style="font-size: 14px; color: var(--discount-purple);">Use Code: <span id="shareOfferCode" style="font-weight: bold;"></span></p>
        <div class="share-platforms">
            <div class="share-platform whatsapp-share" onclick="shareOnWhatsApp()">
                üì±
            </div>
            <div class="share-platform facebook-share" onclick="shareOnFacebook()">
                f
            </div>
            <div class="share-platform instagram-share" onclick="shareOnInstagram()">
                üì∑
            </div>
            <div class="share-platform copy-share" onclick="copyOfferText()">
                üìã
            </div>
        </div>
        <button onclick="closeShareModal()" style="margin-top: 15px; padding: 8px 16px; background: var(--danger-red); color: white; border: none; border-radius: 4px; cursor: pointer;">
            Close
        </button>
    </div>
</div>

<script>
// Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyBBFGIwiuzXNFrJ7kRe1rNauKqolIVMVI4",
    authDomain: "upsm-107f6.firebaseapp.com",
    databaseURL: "https://upsm-107f6-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "upsm-107f6",
    storageBucket: "upsm-107f6.firebasestorage.app",
    messagingSenderId: "359645965485",
    appId: "1:359645965485:web:a8358f7316cc433b182a24",
    measurementId: "G-QYS5PB1C6Y"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Global variables
let currentUserUID = null;
let currentUserData = {};
let billItems = [];
let currentShareOffer = null;
let activeTabID = 'appointments'; 

// Local Storage Keys for Photos
const PRODUCT_PHOTOS_KEY = 'salon_product_photos';
const OFFER_PHOTOS_KEY = 'salon_offer_photos';

// DOM Elements
const $ = (id) => document.getElementById(id);
let navEl;

// Set current month and year in PDF selects
const now = new Date();
$('pdfMonth').value = now.getMonth();
$('pdfYear').value = now.getFullYear();

// Utility Functions
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        if (!file) { return resolve(null); }
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

// Local Storage Functions for Photos
function getProductPhotos() {
    try {
        return JSON.parse(localStorage.getItem(PRODUCT_PHOTOS_KEY)) || {};
    } catch (e) {
        return {};
    }
}

function saveProductPhotos(photos) {
    localStorage.setItem(PRODUCT_PHOTOS_KEY, JSON.stringify(photos));
}

function getOfferPhotos() {
    try {
        return JSON.parse(localStorage.getItem(OFFER_PHOTOS_KEY)) || {};
    } catch (e) {
        return {};
    }
}

function saveOfferPhotos(photos) {
    localStorage.setItem(OFFER_PHOTOS_KEY, JSON.stringify(photos));
}

function getProductPhotoURL(productName) {
    const photos = getProductPhotos();
    return photos[productName] || null;
}

function getOfferPhotoURL(offerTitle) {
    const photos = getOfferPhotos();
    return photos[offerTitle] || null;
}

// Share Modal Functions
function openShareModal(offer) {
    currentShareOffer = offer;
    $('#shareOfferTitle').textContent = offer.title;
    $('#shareOfferCode').textContent = offer.code || 'N/A';
    $('#shareModal').classList.add('active');
}

function closeShareModal() {
    $('#shareModal').classList.remove('active');
    currentShareOffer = null;
}

function getSalonName() {
    return currentUserData.salonName || currentUserData.email || "Our Salon";
}

function getSalonPhone() {
    return currentUserData.phone || "03091539086";
}

function shareOnWhatsApp() {
    if (!currentShareOffer) return;
    
    const offerCodeText = currentShareOffer.code ? `\n\nüîë *Offer Code: ${currentShareOffer.code}*` : ''; // Include code if available

    const shareText = `*üî• Exclusive Offer at ${getSalonName()}! üî•*\n\n` +
                     `üéâ *${currentShareOffer.title}*\n` +
                     `üí´ Get *${currentShareOffer.discount}% OFF* on selected services!` +
                     `${offerCodeText}` +
                     `\n\n‚ú® Don't miss this amazing opportunity!\n` +
                     `üìç Visit us today!\n\n` +
                     `_Contact: ${getSalonPhone()}_\n` +
                     `_Powered by Ali (03091539086) ¬©2025_`;
    
    const encodedMessage = encodeURIComponent(shareText);
    const waLink = `https://wa.me/?text=${encodedMessage}`;
    window.open(waLink, '_blank');
    closeShareModal();
}

function shareOnFacebook() {
    if (!currentShareOffer) return;
    
    const offerCodeText = currentShareOffer.code ? ` - Code: ${currentShareOffer.code}` : '';

    const shareText = `Check out this amazing offer: ${currentShareOffer.title} - ${currentShareOffer.discount}% OFF!${offerCodeText} At ${getSalonName()} | Powered by Ali (03091539086) ¬©2025`;
    const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}&quote=${encodeURIComponent(shareText)}`;
    window.open(facebookUrl, '_blank', 'width=600,height=400');
    closeShareModal();
}

function shareOnInstagram() {
    if (!currentShareOffer) return;
    const offerCodeText = currentShareOffer.code ? ` (Code: ${currentShareOffer.code})` : '';

    alert('To share on Instagram:\n1. Take a screenshot of this offer\n2. Open Instagram\n3. Create a new post with the screenshot\n4. Add relevant hashtags\n\nOffer: ' + currentShareOffer.title + ' - ' + currentShareOffer.discount + '% OFF' + offerCodeText + '\nPowered by Ali (03091539086) ¬©2025');
    closeShareModal();
}

function copyOfferText() {
    if (!currentShareOffer) return;
    
    const offerCodeText = currentShareOffer.code ? `\nüîë Offer Code: ${currentShareOffer.code}` : '';

    const offerText = `üî• Exclusive Offer at ${getSalonName()}! üî•\n\n` +
                     `üéâ ${currentShareOffer.title}\n` +
                     `üí´ Get ${currentShareOffer.discount}% OFF on selected services!` +
                     `${offerCodeText}` +
                     `\n\n‚ú® Don't miss this amazing opportunity!\n` +
                     `üìç Visit us today!\n\n` +
                     `Contact: ${getSalonPhone()}\n` +
                     `Powered by Ali (03091539086) ¬©2025`;
    
    navigator.clipboard.writeText(offerText).then(() => {
        alert('Offer text copied to clipboard!');
    }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = offerText;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('Offer text copied to clipboard!');
    });
    closeShareModal();
}

// Receipt Functions
function updateReceiptDisplay() {
    const customerName = $('#billCustName').value.trim() || "Walk-in Customer";
    const customerPhone = $('#billCustPhone').value.trim() || "N/A";
    
    const subTotal = billItems.reduce((sum, item) => sum + item.total, 0);
    const offerCode = $('#billOfferCode').value.trim().toUpperCase();
    let discount = 0;
    let discountPercent = 0;
    
    if (offerCode) {
        const offer = (currentUserData.offers || []).find(o => o.code === offerCode);
        if (offer) {
            discountPercent = offer.discount;
            discount = subTotal * (discountPercent / 100);
        } else {
             // If offer code is entered but invalid, it's safer not to show 0.00 discount based on an invalid code
             // This is a display function, so we'll only update if a valid code is found.
             // Final validation happens in saveBill().
        }
    }

    const finalTotal = subTotal - discount;

    $('#billReceiptHeader').textContent = getSalonName();
    $('#receiptCustomer').textContent = customerName;
    $('#receiptPhone').textContent = customerPhone;
    $('#receiptDate').textContent = new Date().toLocaleString();
    $('#brandingPhone').textContent = getSalonPhone();
    
    // Updated receipt elements
    $('#billSubTotal').innerText = subTotal.toFixed(2);
    $('#billDiscount').innerText = discount.toFixed(2);
    $('#discountPercent').innerText = `${discountPercent}%`;
    $('#billTotal').innerText = finalTotal.toFixed(2);
}

// MODIFIED getReceiptMessage function
function getReceiptMessage(bill, includeContact = true) {
    const finalTotal = bill.total;
    const subTotal = bill.subTotal;
    const discountAmount = bill.discountAmount;
    const discountCode = bill.discountCode;
    const customerName = bill.customer;
    
    let message = `*üíà ${getSalonName()} - Receipt üíà*\n\n`;
    message += `*Customer:* ${customerName}\n`;
    message += `*Date:* ${bill.date}\n\n`;
    message += `*Items:*\n`;
    
    bill.items.forEach(item => {
        message += `‚Ä¢ ${item.name} x ${item.quantity} = Rs. ${item.total.toFixed(2)}\n`;
    });
    
    message += `\n*Sub Total:* Rs. ${subTotal.toFixed(2)}\n`;
    if (discountAmount > 0) {
        message += `*Discount:* Rs. ${discountAmount.toFixed(2)} (${discountCode})\n`;
    }
    message += `\n*üí∞ GRAND TOTAL: Rs. ${finalTotal.toFixed(2)}*\n\n`;
    message += `Thank you for your business! üéâ\n`;
    
    if (includeContact) {
        message += `_Contact: ${getSalonPhone()}_\n`; 
    }
    
    // Developer Branding
    message += `_Powered by Ali (03091539086) ¬©2025_`;
    
    return message;
}

async function shareReceiptOnWhatsApp(bill = null) {
    let currentBill = bill;
    let isCurrentBill = false;
    
    if (!currentBill) {
        if (billItems.length === 0) {
            alert("Please add items to the bill first.");
            return;
        }
        
        const subTotal = billItems.reduce((s,i) => s + i.total, 0);
        const offerCode = $('#billOfferCode').value.trim().toUpperCase();
        let discount = 0;
        let discountPercent = 0;

        if (offerCode) {
            const offer = (currentUserData.offers || []).find(o => o.code === offerCode);
            if (offer) {
                discountPercent = offer.discount;
                discount = subTotal * (discountPercent / 100);
            }
        }
        
        const finalTotal = subTotal - discount;

        currentBill = {
            customer: $('#billCustName').value.trim() || "Walk-in Customer",
            phone: $('#billCustPhone').value.trim(),
            subTotal: subTotal,
            total: finalTotal,
            discountAmount: discount,
            discountCode: discount > 0 ? offerCode : "N/A",
            date: new Date().toLocaleString(),
            items: billItems
        };
        isCurrentBill = true;
    }
    
    const customerPhone = currentBill.phone;
    const message = getReceiptMessage(currentBill);
    
    if (customerPhone && /^\+?\d{7,15}$/.test(customerPhone)) {
        // Send to specific customer
        const encodedMessage = encodeURIComponent(message);
        const waLink = `https://wa.me/${customerPhone}?text=${encodedMessage}`;
        window.open(waLink, '_blank');
    } else {
        if (isCurrentBill) {
            alert('Please enter a valid customer phone number to send via WhatsApp, or take a screenshot of the receipt.');
        } else {
            // History resend, no phone number available
            const encodedMessage = encodeURIComponent(message);
            const waLink = `https://wa.me/?text=${encodedMessage}`;
            alert('No valid phone number found for this transaction. Sharing text generally.');
            window.open(waLink, '_blank');
        }
    }
}

function downloadReceipt() {
    if (billItems.length === 0) {
        alert("Please add items to the bill first.");
        return;
    }
    
    // We update the receipt display before capture to ensure correct final totals
    updateReceiptDisplay(); 

    html2canvas($('#billReceipt'), {
        scale: 2,
        logging: false,
        useCORS: true,
        backgroundColor: '#ffffff'
    }).then(canvas => {
        const link = document.createElement('a');
        link.download = `salon-receipt-${new Date().getTime()}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
    });
}

// PDF Generation Functions (Omitted for brevity in response, keeping originals)
function generateMonthlyPDF() {
    if (!currentUserUID) {
        alert("Please login first.");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const month = parseInt($('pdfMonth').value);
    const year = parseInt($('pdfYear').value);
    const monthNames = ["January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
    ];
    
    const monthlySales = currentUserData.monthlySales || [];
    const filteredSales = monthlySales.filter(sale => {
        const saleDate = new Date(sale.date);
        return saleDate.getMonth() === month && saleDate.getFullYear() === year;
    });
    
    // PDF Header
    doc.setFontSize(20);
    doc.setTextColor(40, 40, 40);
    doc.text(getSalonName().toUpperCase(), 105, 20, { align: 'center' });
    
    doc.setFontSize(16);
    doc.text(`Monthly Report - ${monthNames[month]} ${year}`, 105, 30, { align: 'center' });
    
    doc.setFontSize(12);
    doc.setTextColor(100, 100, 100);
    doc.text(`Generated on: ${new Date().toLocaleString()}`, 105, 40, { align: 'center' });
    doc.text(`User: ${currentUserData.email}`, 105, 46, { align: 'center' });
    
    // Sales Summary
    let yPosition = 60;
    doc.setFontSize(14);
    doc.setTextColor(40, 40, 40);
    doc.text("Sales Summary", 20, yPosition);
    
    yPosition += 10;
    doc.setFontSize(12);
    const totalMonthlySales = filteredSales.reduce((sum, sale) => sum + sale.amount, 0);
    doc.text(`Total Sales for ${monthNames[month]}: Rs. ${totalMonthlySales.toFixed(2)}`, 20, yPosition);
    
    yPosition += 8;
    doc.text(`Number of Transactions: ${filteredSales.length}`, 20, yPosition);
    
    yPosition += 8;
    doc.text(`Average per Transaction: Rs. ${filteredSales.length > 0 ? (totalMonthlySales / filteredSales.length).toFixed(2) : '0.00'}`, 20, yPosition);
    
    // Sales Table
    yPosition += 20;
    if (filteredSales.length > 0) {
        doc.setFontSize(14);
        doc.text("Daily Sales Breakdown", 20, yPosition);
        yPosition += 10;
        
        const tableData = filteredSales.map(sale => [
            sale.date,
            `Rs. ${sale.amount.toFixed(2)}`
        ]);
        
        doc.autoTable({
            startY: yPosition,
            head: [['Date', 'Amount']],
            body: tableData,
            theme: 'grid',
            headStyles: { fillColor: [24, 119, 242] },
            styles: { fontSize: 10 },
            margin: { left: 20, right: 20 }
        });
        
        yPosition = doc.lastAutoTable.finalY + 10;
    }
    
    // Footer
    doc.setFontSize(10);
    doc.setTextColor(150, 150, 150);
    doc.text(`Contact: ${getSalonPhone()}`, 105, 280, { align: 'center' });
    doc.text(`Powered by Ali (03091539086) ¬©2025`, 105, 285, { align: 'center' });
    
    // Save PDF
    doc.save(`salon-report-${monthNames[month]}-${year}.pdf`);
}

function generateCompletePDF() {
    if (!currentUserUID) {
        alert("Please login first.");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // PDF Header
    doc.setFontSize(20);
    doc.setTextColor(40, 40, 40);
    doc.text(getSalonName().toUpperCase(), 105, 20, { align: 'center' });
    
    doc.setFontSize(16);
    doc.text("Complete Business Report", 105, 30, { align: 'center' });
    
    doc.setFontSize(12);
    doc.setTextColor(100, 100, 100);
    doc.text(`Generated on: ${new Date().toLocaleString()}`, 105, 40, { align: 'center' });
    doc.text(`User: ${currentUserData.email}`, 105, 46, { align: 'center' });
    
    let yPosition = 60;
    
    // Business Overview
    doc.setFontSize(14);
    doc.setTextColor(40, 40, 40);
    doc.text("Business Overview", 20, yPosition);
    
    yPosition += 10;
    doc.setFontSize(12);
    const totalSales = currentUserData.totalSales || 0;
    const monthlySales = currentUserData.monthlySales || [];
    const totalArchived = monthlySales.reduce((sum, sale) => sum + sale.amount, 0);
    const grandTotal = totalSales + totalArchived;
    
    doc.text(`Current Active Sales: Rs. ${totalSales.toFixed(2)}`, 20, yPosition);
    yPosition += 8;
    doc.text(`Archived Sales: Rs. ${totalArchived.toFixed(2)}`, 20, yPosition);
    yPosition += 8;
    doc.text(`Grand Total: Rs. ${grandTotal.toFixed(2)}`, 20, yPosition);
    yPosition += 8;
    doc.text(`Total Transactions: ${monthlySales.length}`, 20, yPosition);
    
    // Products Section
    yPosition += 20;
    const products = currentUserData.products || [];
    if (products.length > 0) {
        doc.setFontSize(14);
        doc.text("Products & Services", 20, yPosition);
        yPosition += 10;
        
        const productData = products.map(prod => [
            prod.name,
            `Rs. ${prod.price.toFixed(2)}`
        ]);
        
        doc.autoTable({
            startY: yPosition,
            head: [['Product/Service', 'Price']],
            body: productData,
            theme: 'grid',
            headStyles: { fillColor: [56, 161, 105] },
            styles: { fontSize: 10 },
            margin: { left: 20, right: 20 }
        });
        
        yPosition = doc.lastAutoTable.finalY + 10;
    }
    
    // Monthly Sales History
    if (monthlySales.length > 0) {
        doc.setFontSize(14);
        doc.text("Complete Sales History", 20, yPosition);
        yPosition += 10;
        
        const salesData = monthlySales.map(sale => [
            sale.date,
            `Rs. ${sale.amount.toFixed(2)}`
        ]);
        
        doc.autoTable({
            startY: yPosition,
            head: [['Date', 'Amount']],
            body: salesData,
            theme: 'grid',
            headStyles: { fillColor: [24, 119, 242] },
            styles: { fontSize: 9 },
            margin: { left: 20, right: 20 }
        });
    }
    
    // Footer
    doc.setFontSize(10);
    doc.setTextColor(150, 150, 150);
    doc.text(`Contact: ${getSalonPhone()}`, 105, 280, { align: 'center' });
    doc.text(`Powered by Ali (03091539086) ¬©2025`, 105, 285, { align: 'center' });
    
    // Save PDF
    doc.save(`salon-complete-report-${new Date().getTime()}.pdf`);
}


// Navigation Functions
function showTab(id, btn) {
    console.log("Showing tab:", id);
    
    activeTabID = id;

    // Hide all sections
    document.querySelectorAll("section").forEach(sec => {
        sec.classList.remove("active");
    });
    
    // Remove active class from all nav buttons
    document.querySelectorAll("#mainNav button").forEach(b => {
        b.classList.remove("active");
    });
    
    // Add active class to clicked button
    if (btn) {
        btn.classList.add("active");
    } else {
        // If 'btn' is not passed (like in loadDashboardData), find it
        const navButton = document.querySelector(`#mainNav button[onclick*="${id}"]`);
        if (navButton) navButton.classList.add("active");
    }
    
    // Show the selected section
    const targetSection = $(id);
    if (targetSection) {
        targetSection.classList.add("active");
    }
    
    // Load specific data for each tab
    if (currentUserUID) {
        switch(id) {
            case 'settings':
                $('userEmailDisplay').textContent = currentUserData.email;
                $('salonNameInput').value = currentUserData.salonName || '';
                $('salonPhoneInput').value = currentUserData.phone || '';
                break;
            case 'appointments':
                renderAppointments(currentUserData.appointments || []);
                break;
            case 'products':
                renderProducts(currentUserData.products || []);
                break;
            case 'offers':
                renderOffers(currentUserData.offers || []);
                break;
            case 'billing':
                renderProducts(currentUserData.products || []);
                updateReceiptDisplay();
                break;
            case 'sales':
                renderMonthlySales(currentUserData.monthlySales || []);
                $('totalSales').innerText = (currentUserData.totalSales || 0).toFixed(2);
                break;
            case 'history':
                renderHistory(currentUserData.history || []); // Full list
                break;
        }
    }
}

// Auth Functions
function showLogin() {
    $('loginForm').classList.remove('hidden');
    $('registerForm').classList.add('hidden');
    $('forgotForm').classList.add('hidden');
}

function showRegister() {
    $('loginForm').classList.add('hidden');
    $('registerForm').classList.remove('hidden');
    $('forgotForm').classList.add('hidden');
}

function showForgot() {
    $('loginForm').classList.add('hidden');
    $('registerForm').classList.add('hidden');
    $('forgotForm').classList.remove('hidden');
}

async function registerUser() {
    let email = $('regEmail').value.trim(), p = $('regPass').value, pin = $('regPin').value.trim();
    if (!email || !p || !pin) return alert("Please fill all fields.");
    if (p.length < 6) return alert("Password must be at least 6 characters long.");
    
    try {
        $('registerForm').classList.add('loading');
        
        const userCredential = await auth.createUserWithEmailAndPassword(email, p);
        const user = userCredential.user;
        
        await db.collection("users").doc(user.uid).set({ 
            email: email, 
            pin: pin, 
            appointments: [], 
            products: [], 
            bills: [], 
            offers: [], 
            totalSales: 0, 
            history: [], 
            monthlySales: [],
            salonName: "My Salon", // Default Name
            phone: "03091539086" // Default Phone
        });
        
        alert("Account created successfully!");
        $('regEmail').value = $('regPass').value = $('regPin').value = '';
        
    } catch(error) {
        console.error("Registration Error:", error);
        let msg = "Registration failed. ";
        if (error.code === 'auth/email-already-in-use') {
            msg = "This email address is already in use.";
        } else if (error.code === 'auth/invalid-email') {
            msg = "The email address is not valid.";
        }
        alert(msg);
    } finally {
        $('registerForm').classList.remove('loading');
    }
}

async function loginUser() {
    let email = $('logEmail').value.trim(), p = $('logPass').value;
    if (!email || !p) return alert("Please enter email and password.");
    
    try {
        $('loginForm').classList.add('loading');
        await auth.signInWithEmailAndPassword(email, p);
        alert("Login successful! Loading dashboard...");
    } catch(error) {
        console.error("Login Error:", error);
        let msg = "Login failed. ";
        if (error.code === 'auth/user-not-found') {
            msg = "No account found with this email.";
        } else if (error.code === 'auth/wrong-password') {
            msg = "Incorrect password.";
        }
        alert(msg);
    } finally {
        $('loginForm').classList.remove('loading');
    }
}

async function logoutUser() {
    try {
        await auth.signOut();
        alert("Logged out successfully.");
    } catch (error) {
        console.error("Logout Error:", error);
        alert("Logout failed.");
    }
}

async function forgotPassword(){
    let email = $('fpEmail').value.trim();
    if (!email) return alert("Please enter your email address.");

    try {
        await auth.sendPasswordResetEmail(email);
        alert("Password reset email sent! Check your inbox.");
        $('fpEmail').value = '';
        showLogin();
    } catch(error) {
        console.error("Forgot Password Error:", error);
        alert("Failed to send reset email. Make sure the email is registered.");
    }
}

// Auth State Listener
auth.onAuthStateChanged((user) => {
    navEl = $('mainNav');

    if (user) {
        currentUserUID = user.uid;
        console.log("User signed in:", user.email);
        loadDashboardData();
    } else {
        currentUserUID = null;
        currentUserData = {};
        navEl.classList.add('hidden'); 
        document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
        $('auth').classList.add('active');
        showLogin();
    }
});

// Settings Functions
async function saveSalonInfo() {
    if (!currentUserUID) return alert("Please log in first.");
    
    const salonName = $('salonNameInput').value.trim();
    const phone = $('salonPhoneInput').value.trim();
    
    if (!salonName || !phone) return alert("Please enter both Salon Name and Contact Phone.");
    
    try {
        await db.collection("users").doc(currentUserUID).update({
            salonName: salonName,
            phone: phone
        });
        alert("Salon Information saved successfully!");
        loadDashboardData(); // Reload data to update all displays
    } catch (error) {
        console.error("Error saving salon info:", error);
        alert("Failed to save salon information.");
    }
}

async function promptChangePin() {
    if (!currentUserUID) return;
    
    const oldPin = prompt("Enter your CURRENT Owner Pin:");
    if (!oldPin) return;

    // Verify current pin first
    try {
        const userDoc = await db.collection("users").doc(currentUserUID).get();
        if(userDoc.exists && userDoc.data().pin === oldPin) {
            const newPin = prompt("Enter your NEW Owner Pin (up to 6 digits):");
            if (!newPin || newPin.length > 6 || !/^\d+$/.test(newPin)) {
                 return alert("Invalid new Pin. Must be up to 6 digits.");
            }
            
            await db.collection("users").doc(currentUserUID).update({
                pin: newPin
            });
            alert("Owner Pin changed successfully!");
            loadDashboardData();
        } else {
            alert("Invalid CURRENT Owner Pin!");
        }
    } catch(error) {
        console.error("Error changing pin:", error);
        alert("Error changing pin. Please try again.");
    }
}


// Data Management
async function loadDashboardData() {
    if (!currentUserUID) return;
    
    try {
        console.log("Loading dashboard data for user:", currentUserUID);
        const userDoc = await db.collection("users").doc(currentUserUID).get();
        
        if (userDoc.exists) {
            currentUserData = userDoc.data();
            // Default values if missing
            currentUserData.salonName = currentUserData.salonName || "My Salon";
            currentUserData.phone = currentUserData.phone || "03091539086";
            
            console.log("User data loaded:", currentUserData);
            
            // Show dashboard
            navEl.classList.remove('hidden'); 
            $('auth').classList.remove('active');
            
            const activeNavButton = document.querySelector(`#mainNav button[onclick*="${activeTabID}"]`);
            showTab(activeTabID, activeNavButton);
            
        } else {
            console.log("No user data found in Firestore");
            alert("No user data found. Please register again.");
        }
    } catch(e) {
        console.error("Error loading dashboard data:", e);
        alert("Failed to load data: " + e.message);
    }
}

// Product Functions
async function addProduct(){
    if(!currentUserUID) return alert("Please log in first.");
    let name = $('prodName').value.trim();
    let price = +$('prodPrice').value;
    const photoFile = $('prodPhoto').files[0];
    
    if (!name || isNaN(price) || price <= 0) return alert("Invalid Name or Price.");

    // Handle photo in local storage
    if (photoFile) {
        try {
            const photoURL = await fileToBase64(photoFile);
            const photos = getProductPhotos();
            photos[name] = photoURL;
            saveProductPhotos(photos);
            console.log("Product photo saved to local storage:", name);
        } catch (e) {
            alert("Image processing failed: " + e.message);
            return;
        }
    }
    
    // Save product data to Firebase (without photoURL)
    let prod = { name, price }; 
    
    try {
        await db.collection("users").doc(currentUserUID).update({ 
            products: firebase.firestore.FieldValue.arrayUnion(prod) 
        });
        
        alert("Product/Service added successfully.");
        $('prodName').value = $('prodPrice').value = '';
        $('prodPhoto').value = null;
        $('prodPhotoPreview').classList.add('hidden');
        loadDashboardData();
    } catch(error) {
        console.error("Error adding product:", error);
        alert("Failed to add product. Please try again.");
    }
}

async function removeProduct(name) {
    if (!currentUserUID) return;
    if (!await verifyOwnerPin()) return; 
    
    const productToRemove = currentUserData.products.find(p => p.name === name);
    if (productToRemove) {
        try {
            await db.collection("users").doc(currentUserUID).update({ 
                products: firebase.firestore.FieldValue.arrayRemove(productToRemove) 
            });
            
            // Also remove photo from local storage
            const photos = getProductPhotos();
            delete photos[name];
            saveProductPhotos(photos);
            console.log("Product photo removed from local storage:", name);
            
            alert("Product/Service removed.");
            loadDashboardData();
        } catch(error) {
            console.error("Error removing product:", error);
            alert("Failed to remove product. Please try again.");
        }
    }
}

// Offer Functions - MODIFIED
async function addOffer(){
    if(!currentUserUID) return alert("Please log in first.");
    let title = $('offerTitle').value.trim();
    let discount = +$('offerDisc').value;
    let code = $('offerCode').value.trim().toUpperCase(); // Get and standardize the offer code
    const photoFile = $('offerPhoto').files[0];

    if (!title || isNaN(discount) || discount <= 0 || discount >= 100) return alert("Invalid Title or Discount (must be between 1 and 99).");
    if (!code) return alert("Please enter a unique Offer Code.");

    // Check for duplicate codes
    if ((currentUserData.offers || []).some(o => o.code === code)) {
        return alert("This Offer Code already exists. Please choose a unique code.");
    }

    // Handle photo in local storage
    if (photoFile) {
        try {
            const photoURL = await fileToBase64(photoFile);
            const photos = getOfferPhotos();
            photos[title] = photoURL;
            saveOfferPhotos(photos);
            console.log("Offer photo saved to local storage:", title);
        } catch (e) {
            alert("Image processing failed: " + e.message);
            return;
        }
    }

    // Save offer data to Firebase (with code)
    let offer = { title, discount, code }; 
    
    try {
        await db.collection("users").doc(currentUserUID).update({ 
            offers: firebase.firestore.FieldValue.arrayUnion(offer) 
        });
        
        alert("Offer added successfully.");
        $('offerTitle').value = $('offerDisc').value = $('offerCode').value = ''; // Reset code
        $('offerPhoto').value = null;
        $('offerPhotoPreview').classList.add('hidden');
        loadDashboardData();
    } catch(error) {
        console.error("Error adding offer:", error);
        alert("Failed to add offer. Please try again.");
    }
}

async function removeOffer(title) {
    if (!currentUserUID) return;
    if (!await verifyOwnerPin()) return; 
    
    const offerToRemove = currentUserData.offers.find(o => o.title === title);
    if (offerToRemove) {
        try {
            await db.collection("users").doc(currentUserUID).update({ 
                offers: firebase.firestore.FieldValue.arrayRemove(offerToRemove) 
            });
            
            // Also remove photo from local storage
            const photos = getOfferPhotos();
            delete photos[title];
            saveOfferPhotos(photos);
            console.log("Offer photo removed from local storage:", title);
            
            alert("Offer removed.");
            loadDashboardData();
        } catch(error) {
            console.error("Error removing offer:", error);
            alert("Failed to remove offer. Please try again.");
        }
    }
}

// Appointment Functions
async function addAppointment(){
    if(!currentUserUID) return alert("Please log in first.");
    let appt = { 
        customer: $('custName').value.trim(), 
        service: $('service').value.trim(), 
        date: $('apptDate').value, 
        time: $('apptTime').value,
        status: 'Pending' 
    };
    if (!appt.customer || !appt.service || !appt.date || !appt.time) return alert("Please fill all appointment details.");
    
    try {
        await db.collection("users").doc(currentUserUID).update({ 
            appointments: firebase.firestore.FieldValue.arrayUnion(appt) 
        });
        
        alert("Appointment added.");
        $('custName').value = $('service').value = $('apptDate').value = $('apptTime').value = '';
        loadDashboardData();
    } catch(error) {
        console.error("Error adding appointment:", error);
        alert("Failed to add appointment. Please try again.");
    }
}

async function manageAppointment(date, time, newStatus) {
    if (!currentUserUID) return;

    const appointments = currentUserData.appointments || [];
    const index = appointments.findIndex(a => a.date === date && a.time === time);
    
    if (index === -1) {
        alert("Appointment not found.");
        loadDashboardData();
        return;
    }
    
    // Remove the old one and add the updated one
    const oldAppt = appointments[index];
    const updatedAppt = { ...oldAppt, status: newStatus };
    
    try {
        // Atomic removal (though not strictly atomic with arrayUnion, it's safer than direct update)
        await db.collection("users").doc(currentUserUID).update({ 
            appointments: firebase.firestore.FieldValue.arrayRemove(oldAppt) 
        });
        await db.collection("users").doc(currentUserUID).update({ 
            appointments: firebase.firestore.FieldValue.arrayUnion(updatedAppt) 
        });
        
        alert(`Appointment status updated to: ${newStatus}`);
        loadDashboardData();
    } catch(error) {
        console.error("Error updating appointment:", error);
        alert("Failed to update appointment. Please try again.");
    }
}

async function deleteAppointment(date, time) {
    if (!currentUserUID) return;
    if (!await verifyOwnerPin()) return; 
    
    const appointmentToDelete = currentUserData.appointments.find(a => a.date === date && a.time === time);
    if (appointmentToDelete) {
        try {
            await db.collection("users").doc(currentUserUID).update({ 
                appointments: firebase.firestore.FieldValue.arrayRemove(appointmentToDelete) 
            });
            alert("Appointment deleted permanently.");
            loadDashboardData();
        } catch(error) {
            console.error("Error deleting appointment:", error);
            alert("Failed to delete appointment. Please try again.");
        }
    }
}

// Billing Functions - MODIFIED
function addBillItem() {
    const productSelect = $('billProd');
    const selectedProduct = productSelect.options[productSelect.selectedIndex];
    if (!selectedProduct || selectedProduct.value === "") {
        alert("Please select a product first.");
        return;
    }
    
    const productName = selectedProduct.text.split(' - ')[0]; // Extract name without price
    const productPrice = parseFloat(selectedProduct.value);
    const quantity = parseInt($('billQty').value) || 1;
    
    const total = productPrice * quantity;
    billItems.push({ name: productName, price: productPrice, quantity: quantity, total: total });
    
    const billTable = $('billTable');
    // Clear the existing items before rendering new ones (including the new item)
    billTable.innerHTML = "<tr><th>Product</th><th>Qty</th><th>Price</th><th>Total</th></tr>";

    billItems.forEach(item => {
        const newRow = billTable.insertRow(billTable.rows.length); 
        newRow.innerHTML = `
            <td>${item.name}</td>
            <td>${item.quantity}</td>
            <td>Rs. ${item.price.toFixed(2)}</td>
            <td>Rs. ${item.total.toFixed(2)}</td>
        `;
    });
    
    $('billQty').value = 1;
    updateReceiptDisplay(); // Now updates all totals
}

async function saveBill(){
    if(!currentUserUID) return alert("Please log in first.");
    if(billItems.length === 0) return alert("The bill is empty.");
    
    const subTotal = billItems.reduce((s,i) => s + i.total, 0);
    const customerName = $('billCustName').value.trim() || "Walk-in Customer";
    const customerPhone = $('billCustPhone').value.trim(); 
    const offerCode = $('billOfferCode').value.trim().toUpperCase();
    
    let discount = 0;
    let discountCode = "N/A";

    if (offerCode) {
        const offer = (currentUserData.offers || []).find(o => o.code === offerCode);
        if (offer) {
            discount = subTotal * (offer.discount / 100);
            discountCode = offerCode;
        } else {
            alert(`Offer Code '${offerCode}' is invalid and was not applied.`);
            $('billOfferCode').value = ''; // Clear invalid code
        }
    }
    
    const finalTotal = subTotal - discount;

    let bill = { 
        id: Date.now(), 
        customer: customerName,
        phone: customerPhone, 
        items: JSON.parse(JSON.stringify(billItems)), 
        subTotal: subTotal,
        discountAmount: discount,
        discountCode: discountCode,
        total: finalTotal, 
        date: new Date().toLocaleString() 
    };

    const newTotalSales = (currentUserData.totalSales || 0) + finalTotal;

    try {
        // Save to Firebase
        await db.collection("users").doc(currentUserUID).update({ 
            history: firebase.firestore.FieldValue.arrayUnion(bill),
            totalSales: newTotalSales 
        });

        // WhatsApp sharing
        // We do this first so the user can see the bill immediately
        await shareReceiptOnWhatsApp(bill);

        alert(`Bill of Rs. ${finalTotal.toFixed(2)} saved!`);

        // Reset
        billItems = []; 
        $('billTable').innerHTML = "<tr><th>Product</th><th>Qty</th><th>Price</th><th>Total</th></tr>";
        $('billCustName').value = $('billCustPhone').value = '';
        $('billOfferCode').value = ''; // Reset offer code input
        updateReceiptDisplay(); // Reset receipt info
        
        loadDashboardData();
    } catch(error) {
        console.error("Error saving bill:", error);
        alert("Failed to save bill. Please try again.");
    }
}

// Sales Functions
async function closeDay() {
    if (!currentUserUID) return alert("Please log in first.");
    if (!await verifyOwnerPin()) return; 

    const currentSales = currentUserData.totalSales || 0;
    if (currentSales === 0) return alert("No sales to close for today/this period.");

    const confirmation = confirm(`Are you sure you want to close the day/period? Sales amount Rs. ${currentSales.toFixed(2)} will be archived and the current total will be reset to 0.`);
    if (!confirmation) return;
    
    const salesRecord = {
        date: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }),
        amount: currentSales
    };

    try {
        await db.collection("users").doc(currentUserUID).update({ 
            monthlySales: firebase.firestore.FieldValue.arrayUnion(salesRecord),
            totalSales: 0 
        });
        
        alert(`Day closed successfully! Sales of Rs. ${currentSales.toFixed(2)} archived.`);
        loadDashboardData();
    } catch(error) {
        console.error("Error closing day:", error);
        alert("Failed to close day. Please try again.");
    }
}

// History/Customer Management Functions - ADDED/MODIFIED
async function promptAddCustomer() {
    if (!currentUserUID) return alert("Please log in first.");
    if (!await verifyOwnerPin()) return; // Admin pin check

    const name = prompt("Enter New Customer Name:");
    if (!name || name.trim() === "") return;

    const phone = prompt(`Enter Phone Number for ${name}:`);
    if (!phone || phone.trim() === "") return;

    // Save as a 'meta-history' item to record the customer
    const newCustomerEntry = {
        id: Date.now(),
        customer: name.trim(),
        phone: phone.trim(),
        items: [], // Empty items array
        subTotal: 0,
        discountAmount: 0,
        discountCode: "N/A",
        total: 0,
        date: new Date().toLocaleDateString() + " (Added Manually)"
    };
    
    try {
        await db.collection("users").doc(currentUserUID).update({
            history: firebase.firestore.FieldValue.arrayUnion(newCustomerEntry)
        });
        alert(`Customer ${name} added successfully.`);
        loadDashboardData();
    } catch(error) {
        console.error("Error adding customer:", error);
        alert("Failed to add customer. Please try again.");
    }
}

async function deleteCustomerByName(name) {
    if (!currentUserUID) return;
    if (!await verifyOwnerPin()) return;

    if (confirm(`Are you sure you want to delete ALL transaction records for customer: ${name}? This cannot be undone.`)) {
        try {
            const history = currentUserData.history || [];
            const updatedHistory = history.filter(bill => bill.customer !== name);

            // Directly overwrite the history array with the filtered array
            await db.collection("users").doc(currentUserUID).update({
                history: updatedHistory
            });
            alert(`All records for customer ${name} deleted successfully.`);
            loadDashboardData();
        } catch (error) {
            console.error("Error deleting customer records:", error);
            alert("Failed to delete customer records. Please try again.");
        }
    }
}

function searchCustomer() {
    const searchTerm = $('customerSearchInput').value.trim().toLowerCase();
    renderHistory(currentUserData.history || [], searchTerm);
}

// Function to auto-fill phone when customer name is typed - ADDED
function autoFillCustomerPhone() {
    const customerName = $('billCustName').value.trim();
    const customerPhoneInput = $('billCustPhone');
    
    const customers = {};
    (currentUserData.history || []).forEach(bill => {
        // Only record the phone if it's a valid string and not "N/A"
        if (bill.phone && bill.phone.trim() !== '' && bill.phone.trim().toLowerCase() !== 'n/a') {
            customers[bill.customer] = bill.phone.trim();
        }
    });

    // If the customer name is found in the collected list, fill the phone number
    if (customers[customerName]) {
        customerPhoneInput.value = customers[customerName];
    } else if (customerPhoneInput.value.trim() !== '') {
        // If the customer name does not match, but the phone input already has text, don't clear it.
        // The user might be typing a new customer's number.
    } else {
        // Clear the phone if the name doesn't match a stored customer and phone is empty
        customerPhoneInput.value = '';
    }
    
    // Always call this to ensure receipt totals and display are updated
    updateReceiptDisplay(); 
}

async function deleteHistoryItem(bill) {
    if (!currentUserUID) return;
    if (!await verifyOwnerPin()) return; 

    if (confirm(`Are you sure you want to delete the transaction for ${bill.customer} (Rs. ${bill.total.toFixed(2)})? This cannot be undone.`)) {
        try {
            await db.collection("users").doc(currentUserUID).update({ 
                history: firebase.firestore.FieldValue.arrayRemove(bill) 
            });
            alert("Transaction deleted successfully.");
            loadDashboardData();
        } catch(error) {
            console.error("Error deleting transaction:", error);
            alert("Failed to delete transaction. Please try again.");
        }
    }
}


// Pin Verification
async function verifyOwnerPin() {
    if (!currentUserUID) return false;
    const inputPin = prompt("Enter Owner Pin to confirm this action:");
    if (!inputPin) return false;
    
    try {
        const userDoc = await db.collection("users").doc(currentUserUID).get();
        if(userDoc.exists && userDoc.data().pin === inputPin) {
            return true;
        } else {
            alert("Invalid Owner Pin!");
            return false;
        }
    } catch(error) {
        console.error("Error verifying pin:", error);
        alert("Error verifying pin. Please try again.");
        return false;
    }
}

// Rendering Functions - MODIFIED
function renderAppointments(appointments) {
    const table = $('apptTable');
    if (!table) return;
    
    table.innerHTML = `<tr><th>Customer</th><th>Service</th><th>Date</th><th>Time</th><th>Status</th><th>Actions</th></tr>`;
    
    if (appointments.length === 0) {
        const row = table.insertRow();
        row.innerHTML = `<td colspan="6" style="text-align:center; color:#999;">No appointments found</td>`;
        return;
    }
    
    appointments.sort((a, b) => new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time))
                .forEach(appt => {
        const row = table.insertRow();
        row.innerHTML = `
            <td>${appt.customer}</td>
            <td>${appt.service}</td>
            <td>${appt.date}</td>
            <td>${appt.time}</td>
            <td>
                <select class="status-select" onchange="manageAppointment('${appt.date}', '${appt.time}', this.value)">
                    <option value="Pending" ${appt.status === 'Pending' ? 'selected' : ''}>Pending</option>
                    <option value="Confirmed" ${appt.status === 'Confirmed' ? 'selected' : ''}>Confirmed</option>
                    <option value="Completed" ${appt.status === 'Completed' ? 'selected' : ''}>Completed</option>
                    <option value="Cancelled" ${appt.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                </select>
            </td>
            <td>
                <button class="delete-btn" onclick="deleteAppointment('${appt.date}', '${appt.time}')">Delete</button>
            </td>
        `;
    });
}

function renderProducts(products) {
    const feed = $('prodFeed');
    const billSelect = $('billProd');
    
    if (!feed || !billSelect) return;
    
    feed.innerHTML = '';
    billSelect.innerHTML = '<option value="">Select Product</option>';
    
    if (products.length === 0) {
        feed.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">No products found</div>';
        return;
    }
    
    products.forEach(prod => {
        // Get photo from local storage
        const photoURL = getProductPhotoURL(prod.name);
        
        const card = document.createElement('div');
        card.className = 'feed-card';
        card.innerHTML = `
            ${photoURL ? `<img src="${photoURL}" class="feed-image" alt="${prod.name}">` : '<div class="feed-image" style="background:#f0f2f5; display:flex; align-items:center; justify-content:center;">üì¶</div>'}
            <div style="flex:1;">
                <h4 style="margin:0 0 5px 0;">${prod.name}</h4>
                <p style="margin:0; color:var(--success-green); font-weight:bold;">Rs. ${prod.price.toFixed(2)}</p>
            </div>
            <div class="feed-actions">
                <button class="delete-btn" onclick="removeProduct('${prod.name}')">Delete</button>
            </div>
        `;
        feed.appendChild(card);
        
        const option = document.createElement('option');
        option.value = prod.price;
        option.textContent = `${prod.name} - Rs. ${prod.price.toFixed(2)}`;
        billSelect.appendChild(option);
    });
}

function renderOffers(offers) {
    const feed = $('offerFeed');
    if (!feed) return;
    
    feed.innerHTML = '';
    
    if (offers.length === 0) {
        feed.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">No offers found</div>';
        return;
    }
    
    offers.forEach(offer => {
        // Get photo from local storage
        const photoURL = getOfferPhotoURL(offer.title);
        
        const card = document.createElement('div');
        card.className = 'feed-card';
        card.innerHTML = `
            ${photoURL ? `<img src="${photoURL}" class="feed-image" alt="${offer.title}">` : '<div class="feed-image" style="background:#f0f2f5; display:flex; align-items:center; justify-content:center;">üéÅ</div>'}
            <div style="flex:1;">
                <h4 style="margin:0 0 5px 0;">${offer.title}</h4>
                <p style="margin:0; color:var(--danger-red); font-weight:bold;">${offer.discount}% OFF</p>
                <p style="margin:5px 0 0 0; font-size:12px; color:var(--discount-purple);">Code: <span style="font-weight:bold;">${offer.code || 'N/A'}</span></p>
                <p style="margin:0; font-size:12px; color:#666;">Click share to promote this offer!</p>
            </div>
            <div class="feed-actions">
                <button class="share-btn" onclick="openShareModal(${JSON.stringify(offer).replace(/"/g, '&quot;')})" style="background: var(--primary-blue);">üì§ Share</button>
                <button class="delete-btn" onclick="removeOffer('${offer.title}')">Delete</button>
            </div>
        `;
        feed.appendChild(card);
    });
}

// MODIFIED renderHistory to support search and customer management
function renderHistory(history, searchTerm = '') {
    const table = $('histTable');
    const customerListDiv = $('customerList');
    const customerNamesDatalist = $('customerNames');
    
    if (!table || !customerListDiv || !customerNamesDatalist) return;
    
    table.innerHTML = `<tr><th>Customer</th><th>Phone</th><th>Total Bill</th><th>Date</th><th>Actions</th></tr>`;
    customerListDiv.innerHTML = '';
    customerNamesDatalist.innerHTML = ''; // Clear datalist

    if (history.length === 0) {
        table.innerHTML = `<tr><td colspan="5" style="text-align:center; color:#999;">No transaction history found</td></tr>`;
        customerListDiv.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">No customers found</div>';
        return;
    }
    
    // 1. Process and filter unique customers
    const customers = {};
    history.forEach(bill => {
        const name = bill.customer;
        const phone = bill.phone || 'N/A';
        
        // Use the customer name as the key
        if (name && name !== 'Walk-in Customer') {
            if (!customers[name]) {
                customers[name] = {
                    phone: phone,
                    totalSpent: 0,
                    lastVisit: bill.date,
                    historyCount: 0
                };
            }
            // Only add to total spent if it was a real transaction
            if (bill.total > 0) {
                 customers[name].totalSpent += bill.total;
                 customers[name].historyCount++;
            }
            
            // Update last visit
            if (new Date(bill.date) > new Date(customers[name].lastVisit)) {
                customers[name].lastVisit = bill.date;
            }
            
            // Update phone (to the latest recorded phone, if available)
            if (phone !== 'N/A') {
                 customers[name].phone = phone;
            }
        }
    });
    
    const customerArray = Object.keys(customers).map(name => ({ name, ...customers[name] }));

    // 2. Render customer list (filtered by search term)
    const filteredCustomers = customerArray.filter(cust => 
        cust.name.toLowerCase().includes(searchTerm.toLowerCase())
    );

    if (filteredCustomers.length === 0 && searchTerm !== '') {
        customerListDiv.innerHTML = `<div style="text-align:center; color:#999; padding:20px;">No customers found matching "${searchTerm}"</div>`;
    } else if (filteredCustomers.length === 0) {
        customerListDiv.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">No recorded customers found</div>';
    } else {
        filteredCustomers.forEach(customer => {
            const div = document.createElement('div');
            div.className = 'feed-card';
            div.innerHTML = `
                <div style="flex:1;">
                    <h4 style="margin:0 0 5px 0;">${customer.name}</h4>
                    <p style="margin:0; font-size:12px;">Phone: ${customer.phone || 'N/A'}</p>
                    <p style="margin:0; font-size:12px;">Total Transactions: ${customer.historyCount}</p>
                    <p style="margin:0; font-size:12px; color:var(--primary-blue); font-weight:bold;">Total Spent: Rs. ${customer.totalSpent.toFixed(2)}</p>
                    <p style="margin:0; font-size:12px;">Last Visit: ${customer.lastVisit}</p>
                </div>
                <div class="feed-actions">
                    <button class="delete-btn" onclick="deleteCustomerByName('${customer.name}')">Delete All üóëÔ∏è</button>
                </div>
            `;
            customerListDiv.appendChild(div);
            
            // Add to datalist for auto-fill in billing
            const option = document.createElement('option');
            option.value = customer.name;
            customerNamesDatalist.appendChild(option);
        });
    }
    
    // 3. Render transaction history (unfiltered)
    history.sort((a, b) => new Date(b.date) - new Date(a.date))
          .forEach(bill => {
        // Skip manually added entries with no sales to only show real transactions in history table
        if (bill.total === 0 && bill.date.includes("(Added Manually)")) {
             return;
        }

        const billJson = JSON.stringify(bill).replace(/"/g, '&quot;');
        const row = table.insertRow();
        row.innerHTML = `
            <td>${bill.customer}</td>
            <td>${bill.phone || 'N/A'}</td>
            <td>Rs. ${bill.total.toFixed(2)}</td>
            <td>${bill.date}</td>
            <td>
                <button class="resend-btn" onclick="shareReceiptOnWhatsApp(${billJson})">Resend üì±</button>
                <button class="delete-btn" onclick="deleteHistoryItem(${billJson})">Delete</button>
            </td>
        `;
    });
}

function renderMonthlySales(monthlySales) {
    const table = $('monthlySalesTable');
    if (!table) return;
    
    table.innerHTML = `<tr><th>Date</th><th>Sales Amount</th></tr>`;
    
    if (monthlySales.length === 0) {
        const row = table.insertRow();
        row.innerHTML = `<td colspan="2" style="text-align:center; color:#999;">No sales history found</td>`;
        return;
    }
    
    monthlySales.sort((a, b) => new Date(b.date) - new Date(a.date))
               .forEach(sale => {
        const row = table.insertRow();
        row.innerHTML = `
            <td>${sale.date}</td>
            <td>Rs. ${sale.amount.toFixed(2)}</td>
        `;
    });
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    navEl = $('mainNav');
    
    const today = new Date().toISOString().split('T')[0];
    $('apptDate').value = today;
    
    const now = new Date();
    const hours = now.getHours().toString().padStart(2, '0');
    const minutes = now.getMinutes().getMinutes().toString().padStart(2, '0');
    $('apptTime').value = `${hours}:${minutes}`;
    
    console.log("App initialized");
    console.log("Product photos in local storage:", Object.keys(getProductPhotos()).length);
    console.log("Offer photos in local storage:", Object.keys(getOfferPhotos()).length);
    
    // Initial receipt update
    updateReceiptDisplay();
});

// File preview handlers
$('prodPhoto').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const preview = $('prodPhotoPreview');
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            preview.classList.remove('hidden');
        }
        reader.readAsDataURL(file);
    } else {
        preview.classList.add('hidden');
    }
});

$('offerPhoto').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const preview = $('offerPhotoPreview');
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            preview.classList.remove('hidden');
        }
        reader.readAsDataURL(file);
    } else {
        preview.classList.add('hidden');
    }
});

// Event listeners for customer info changes AND offer code change - MODIFIED
$('billCustName').addEventListener('input', autoFillCustomerPhone);
$('billCustPhone').addEventListener('input', updateReceiptDisplay);
$('billOfferCode').addEventListener('input', updateReceiptDisplay);


// Make functions global
window.showTab = showTab;
window.showLogin = showLogin;
window.showRegister = showRegister;
window.showForgot = showForgot;
window.registerUser = registerUser;
window.loginUser = loginUser;
window.logoutUser = logoutUser;
window.forgotPassword = forgotPassword;
window.verifyOwnerPin = verifyOwnerPin;
window.manageAppointment = manageAppointment;
window.deleteAppointment = deleteAppointment;
window.addAppointment = addAppointment;
window.addProduct = addProduct;
window.removeProduct = removeProduct;
window.addOffer = addOffer;
window.removeOffer = removeOffer;
window.addBillItem = addBillItem;
window.saveBill = saveBill;
window.closeDay = closeDay;
window.generateMonthlyPDF = generateMonthlyPDF;
window.generateCompletePDF = generateCompletePDF;
window.openShareModal = openShareModal;
window.closeShareModal = closeShareModal;
window.shareOnWhatsApp = shareOnWhatsApp;
window.shareOnFacebook = shareOnFacebook;
window.shareOnInstagram = shareOnInstagram;
window.copyOfferText = copyOfferText;
window.shareReceiptOnWhatsApp = shareReceiptOnWhatsApp;
window.downloadReceipt = downloadReceipt;
window.saveSalonInfo = saveSalonInfo;
window.promptChangePin = promptChangePin;
window.deleteHistoryItem = deleteHistoryItem;

// New Customer Management Functions
window.promptAddCustomer = promptAddCustomer;
window.deleteCustomerByName = deleteCustomerByName;
window.searchCustomer = searchCustomer;
window.autoFillCustomerPhone = autoFillCustomerPhone;
</script>
</body>
</html>
