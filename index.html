<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Salon Manager Pro (Salamat Ali)</title>
<style>
/* --- CSS --- */
:root {
    --primary-blue: #1877f2; 
    --light-bg: #f0f2f5;    
    --card-bg: #ffffff;
    --text-color: #050505;
    --border-color: #dddfe2;
    --success-green: #38a169;
    --danger-red: #fa383e;
}
body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--light-bg);
    color: var(--text-color);
}
header {
    background: var(--card-bg);
    color: var(--primary-blue);
    padding: 15px 20px;
    text-align: center;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    position: sticky;
    top: 0;
    z-index: 1000;
}
header h1 {
    margin: 0;
    font-size: 24px;
}
nav {
    background: var(--card-bg);
    padding: 0;
    display: flex;
    overflow-x: auto;
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 15px;
}
nav button {
    flex-shrink: 0;
    padding: 12px 15px;
    background: transparent;
    border: none;
    color: #606770;
    cursor: pointer;
    transition: background 0.3s, color 0.3s;
    font-size: 14px;
    border-bottom: 2px solid transparent;
}
nav button.action {
    background: var(--primary-blue);
    color: white;
    margin-left: auto;
    border-radius: 6px;
    margin-right: 15px;
}
nav button.active {
    color: var(--primary-blue);
    border-bottom: 2px solid var(--primary-blue);
    background: var(--light-bg);
}
nav button:not(.active):hover:not(.action) {
    background: #f0f2f5;
    color: var(--text-color);
}
section {
    padding: 20px;
    display: none;
    max-width: 800px;
    margin: 20px auto;
}
section.active {
    display: block;
    background: var(--card-bg);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}
h2 {
    color: var(--primary-blue);
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 10px;
    margin-top: 0;
    font-size: 20px;
}
h3 {
    color: #606770;
}
input, select {
    padding: 10px;
    margin: 8px 0;
    width: calc(100% - 20px);
    box-sizing: border-box;
    border: 1px solid var(--border-color);
    background: var(--card-bg);
    color: var(--text-color);
    border-radius: 6px;
}
button.action {
    padding: 10px 18px;
    margin-top: 10px;
    background: var(--primary-blue);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.2s;
}
button.action:hover {
    background: #1660b4;
}
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    border-radius: 8px;
    overflow: hidden;
}
th, td {
    border: 1px solid var(--border-color);
    padding: 12px 10px;
    text-align: left;
}
th {
    background: var(--light-bg);
    color: #606770;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 12px;
}
.row-actions button {
    padding: 5px 10px;
    background: var(--danger-red); 
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    margin-left: 5px;
}
.row-actions .share-btn {
    background: var(--success-green); 
}
.row-actions .share-btn:hover {
    background: #128c7e;
}

/* Appointment Status Styling */
.status-select {
    padding: 5px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--card-bg);
    width: 100%;
}
.delete-btn {
    background: var(--danger-red);
    color: white;
    padding: 5px 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    display: none; 
}
.delete-btn:hover {
    background: #c9302c;
}

/* --- Other Sections CSS --- */
.hidden { display: none !important; }
.scrollable-feed {
    display: flex;
    flex-direction: column;
    gap: 15px;
    max-height: 70vh; 
    overflow-y: auto;
    padding-right: 5px; 
}
.feed-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    display: flex;
    gap: 15px;
    align-items: center;
}
.feed-image {
    width: 80px;
    height: 80px;
    border-radius: 4px;
    object-fit: cover;
    border: 1px solid var(--border-color);
    flex-shrink: 0;
}
.feed-actions {
    flex-shrink: 0;
    display: flex; 
    gap: 5px;
}

/* --- BILL RECEIPT CONTAINER --- */
#billReceipt {
    padding: 15px;
    background: var(--card-bg);
    border: 1px dashed #606770;
    margin-bottom: 15px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 14px;
}
#billReceipt h3, #billReceipt table {
    margin: 5px 0;
}
#billReceipt h3 {
    text-align: center;
    color: var(--primary-blue);
}
#billReceipt table {
    width: 100%;
}
#billReceipt th, #billReceipt td {
    padding: 5px 0;
    border: none;
    border-bottom: 1px dotted #ccc;
    font-size: 13px;
    vertical-align: top;
}

.form-row {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}
.form-row input, .form-row select {
    flex: 1;
}
.photo-preview {
    max-width: 100px;
    max-height: 100px;
    margin-top: 10px;
    border-radius: 4px;
}
.auth-link-button {
    background: none;
    border: none;
    color: var(--primary-blue);
    cursor: pointer;
    text-decoration: underline;
    margin: 5px;
}
.loading {
    opacity: 0.7;
    pointer-events: none;
}
</style>
</head>
<body>

<header>
  <h1>Salon Manager Pro (Salamat Ali) üíá‚Äç‚ôÇÔ∏è</h1>
</header>

<nav id="mainNav" class="hidden">
  <button onclick="showTab('appointments', this)">Appointments</button>
  <button onclick="showTab('products', this)">Products</button>
  <button onclick="showTab('offers', this)">Offers</button>
  <button onclick="showTab('billing', this)">Billing</button>
  <button onclick="showTab('sales', this)">Sales</button>
  <button onclick="showTab('history', this)">Customers & History</button>
  <button class="action" onclick="logoutUser()">Logout</button>
</nav>

<section id="auth" class="active">
  <h2>Access Control</h2>
  <div id="loginForm">
    <h3>Existing User (Login)</h3>
    <input id="logEmail" type="email" placeholder="Email Address">
    <input id="logPass" type="password" placeholder="Password">
    <button class="action" onclick="loginUser()">Login</button>
    <div style="text-align: center; margin-top: 15px;">
        <button class="auth-link-button" onclick="showForgot()">Forgot Password?</button>
        <hr style="border-color:var(--border-color); margin:10px 0;">
        <button class="action" onclick="showRegister()">Register New Account</button>
    </div>
  </div>
  <div id="registerForm" class="hidden">
    <h3>New Account (Register)</h3>
    <input id="regEmail" type="email" placeholder="Email Address">
    <input id="regPass" type="password" placeholder="Password (min 6 chars)">
    <input id="regPin" placeholder="Owner Pin (for admin access)" maxlength="6">
    <button class="action" onclick="registerUser()">Register</button>
    <button class="auth-link-button" onclick="showLogin()">‚Üê Back to Login</button>
  </div>
  <div id="forgotForm" class="hidden">
    <h3>Forgot Password</h3>
    <p>We will send a password reset link to your email.</p>
    <input id="fpEmail" type="email" placeholder="Email Address">
    <button class="action" onclick="forgotPassword()">Send Reset Email</button>
    <button class="auth-link-button" onclick="showLogin()">‚Üê Back to Login</button>
  </div>
</section>

<section id="appointments">
  <h2>Book New Appointment üìÖ</h2>
  <div class="form-row">
    <input id="custName" placeholder="Customer Name">
    <input id="service" placeholder="Service (e.g., Haircut)">
  </div>
  <div class="form-row">
    <input id="apptDate" type="date">
    <input id="apptTime" type="time">
  </div>
  <button class="action" onclick="addAppointment()">Add Appointment</button>
  
  <h3>Upcoming Appointments</h3>
  <table id="apptTable">
    <tr><th>Customer</th><th>Service</th><th>Date</th><th>Time</th><th>Status</th><th>Delete</th></tr> 
  </table>
</section>

<section id="products">
  <h2>Products & Services üõçÔ∏è</h2>
  <div class="form-row">
    <input id="prodName" placeholder="Name">
    <input id="prodPrice" type="number" placeholder="Price">
  </div>
  <div class="form-group">
    <label>Product Image (Optional)</label>
    <input id="prodPhoto" type="file" accept="image/*">
    <img id="prodPhotoPreview" class="photo-preview hidden" src="" alt="Product Preview">
  </div>
  <button class="action" onclick="addProduct()">Add Product/Service</button>
  
  <h3>Current Price List (Scrollable Feed)</h3>
  <div id="prodFeed" class="scrollable-feed">
    </div>
</section>

<section id="offers">
  <h2>Active Offers üéÅ</h2>
  <div class="form-row">
    <input id="offerTitle" placeholder="Offer Title">
    <input id="offerDisc" type="number" placeholder="Discount %">
  </div>
  <div class="form-group">
    <label>Offer Image (Optional)</label>
    <input id="offerPhoto" type="file" accept="image/*">
    <img id="offerPhotoPreview" class="photo-preview hidden" src="" alt="Offer Preview">
  </div>
  <button class="action" onclick="addOffer()">Add New Offer</button>
  
  <h3>Offer List (Scrollable Feed)</h3>
  <div id="offerFeed" class="scrollable-feed">
    </div>
</section>

<section id="billing">
  <h2>Create New Bill üßæ</h2>
  <div class="form-row">
    <input id="billCustName" placeholder="Customer Name">
    <input id="billCustPhone" placeholder="Customer Phone (for WhatsApp)">
  </div>
  <div class="form-row">
    <select id="billProd"></select>
    <input id="billQty" type="number" value="1" min="1" placeholder="Quantity">
  </div>
  <button class="action" onclick="addBillItem()">Add Item to Bill</button>
  <div id="billReceipt">
    <h3 id="billReceiptHeader" style="border-bottom: 1px dotted #ccc;">SALON BILL RECEIPT</h3>
    <table id="billTable">
      <tr><th>Product</th><th>Qty</th><th>Price</th><th>Total</th></tr>
    </table>
    <h3 style="text-align: right; border-top: 1px dotted #ccc; padding-top: 5px;">
      NET TOTAL: <span id="billTotal" style="color:var(--primary-blue);">0.00</span>
    </h3>
  </div>
  <button class="action" onclick="saveBill()">Finalize & Save Bill</button>
</section>

<section id="sales">
  <h2>Sales Report üìà</h2>
  <h3 style="color: var(--primary-blue);">
    Current Month/Day Sales: <span id="totalSales">0.00</span>
  </h3>
  <button class="action" onclick="closeDay()" style="background: var(--success-green);">Close Day & Reset Sales</button>
  <button class="action" onclick="generatePDFStatement()">Generate Monthly Sales PDF</button>

  <h2 style="margin-top: 30px;">Monthly Sales History üí∞</h2>
  <table id="monthlySalesTable">
      <tr><th>Date</th><th>Sales Amount</th></tr>
  </table>
</section>

<section id="history">
  <h2>Customer List üßë‚Äçü§ù‚Äçüßë</h2>
  <div id="customerList">
    </div>

  <h2 style="margin-top: 30px;">Transaction History üìú</h2>
  <table id="histTable">
    <tr><th>Customer</th><th>Phone</th><th>Total Bill</th><th>Date</th></tr>
  </table>
</section>

<script type="module">
  // Firebase imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove } 
    from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, onAuthStateChanged } 
    from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

  // Your Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyBBFGIwiuzXNFrJ7kRe1rNauKqolIVMVI4",
    authDomain: "upsm-107f6.firebaseapp.com",
    databaseURL: "https://upsm-107f6-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "upsm-107f6",
    storageBucket: "upsm-107f6.firebasestorage.app",
    messagingSenderId: "359645965485",
    appId: "1:359645965485:web:a8358f7316cc433b182a24",
    measurementId: "G-QYS5PB1C6Y"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // Global variables
  let currentUserUID = null;
  let currentUserData = {};
  let billItems = [];

  // DOM Elements
  const $ = (id) => document.getElementById(id);
  let navEl;

  // Utility Functions
  function fileToBase64(file) {
      return new Promise((resolve, reject) => {
          if (!file) { return resolve(null); }
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => resolve(reader.result);
          reader.onerror = error => reject(error);
      });
  }

  // Navigation Functions
  window.showTab = function(id, btn) {
      document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
      document.querySelectorAll("#mainNav button").forEach(b => b.classList.remove("active"));
      
      if (btn) btn.classList.add("active");
      
      $(id).classList.add("active");

      if (currentUserUID && ['appointments', 'products', 'offers', 'sales', 'history'].includes(id)) {
          loadDashboardData();
      }
      if (id === 'billing') {
          renderProducts(currentUserData.products || []);
      }
  }

  // Auth Functions
  window.showLogin = function() {
      $('loginForm').classList.remove('hidden');
      $('registerForm').classList.add('hidden');
      $('forgotForm').classList.add('hidden');
  }

  window.showRegister = function() {
      $('loginForm').classList.add('hidden');
      $('registerForm').classList.remove('hidden');
      $('forgotForm').classList.add('hidden');
  }

  window.showForgot = function() {
      $('loginForm').classList.add('hidden');
      $('registerForm').classList.add('hidden');
      $('forgotForm').classList.remove('hidden');
  }

  window.registerUser = async function() {
      let email = $('regEmail').value.trim(), p = $('regPass').value, pin = $('regPin').value.trim();
      if (!email || !p || !pin) return alert("Please fill all fields.");
      if (p.length < 6) return alert("Password must be at least 6 characters long.");
      
      try {
          // Show loading
          $('registerForm').classList.add('loading');
          
          // Create user with Firebase Auth
          const userCredential = await createUserWithEmailAndPassword(auth, email, p);
          const user = userCredential.user;
          
          // Create user document in Firestore
          await setDoc(doc(db, "users", user.uid), { 
              email: email, 
              pin: pin, 
              appointments: [], 
              products: [], 
              bills: [], 
              offers: [], 
              totalSales: 0, 
              history: [], 
              monthlySales: [] 
          });
          
          alert("Account created successfully!");
          
          // Clear forms
          $('regEmail').value = $('regPass').value = $('regPin').value = '';
          
      } catch(error) {
          console.error("Registration Error:", error);
          let msg = "Registration failed. ";
          if (error.code === 'auth/email-already-in-use') {
              msg = "This email address is already in use.";
          } else if (error.code === 'auth/invalid-email') {
              msg = "The email address is not valid.";
          } else if (error.code === 'auth/weak-password') {
              msg = "Password is too weak.";
          }
          alert(msg);
      } finally {
          $('registerForm').classList.remove('loading');
      }
  }

  window.loginUser = async function() {
      let email = $('logEmail').value.trim(), p = $('logPass').value;
      if (!email || !p) return alert("Please enter email and password.");
      
      try {
          // Show loading
          $('loginForm').classList.add('loading');
          
          // Sign in with Firebase Auth
          await signInWithEmailAndPassword(auth, email, p);
          alert("Login successful! Loading dashboard...");
          
      } catch(error) {
          console.error("Login Error:", error);
          let msg = "Login failed. ";
          if (error.code === 'auth/invalid-email') {
              msg = "Invalid email address.";
          } else if (error.code === 'auth/user-not-found') {
              msg = "No account found with this email.";
          } else if (error.code === 'auth/wrong-password') {
              msg = "Incorrect password.";
          } else if (error.code === 'auth/too-many-requests') {
              msg = "Too many failed attempts. Please try again later.";
          }
          alert(msg);
      } finally {
          $('loginForm').classList.remove('loading');
      }
  }

  window.logoutUser = async function() {
      try {
          await signOut(auth);
          alert("Logged out successfully.");
      } catch (error) {
          console.error("Logout Error:", error);
          alert("Logout failed.");
      }
  }

  window.forgotPassword = async function(){
      let email = $('fpEmail').value.trim();
      if (!email) return alert("Please enter your email address.");

      try {
          await sendPasswordResetEmail(auth, email);
          alert("Password reset email sent! Check your inbox.");
          $('fpEmail').value = '';
          window.showLogin();
      } catch(error) {
          console.error("Forgot Password Error:", error);
          let msg = "Failed to send reset email. ";
          if (error.code === 'auth/user-not-found') {
              msg = "No account found with this email.";
          } else if (error.code === 'auth/invalid-email') {
              msg = "Invalid email address.";
          }
          alert(msg);
      }
  }

  // Auth State Listener
  onAuthStateChanged(auth, (user) => {
      navEl = $('mainNav');

      if (user) {
          // User is signed in
          currentUserUID = user.uid;
          console.log("User signed in:", user.email);
          loadDashboardData();
      } else {
          // User is signed out
          currentUserUID = null;
          currentUserData = {};
          
          // Show auth screen
          navEl.classList.add('hidden'); 
          document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
          $('auth').classList.add('active');
          window.showLogin();
      }
  });

  // Data Management
  async function loadDashboardData() {
      if (!currentUserUID) return;
      
      try {
          const userDoc = await getDoc(doc(db, "users", currentUserUID));
          
          if (userDoc.exists()) {
              currentUserData = userDoc.data();
              
              // Render all data
              renderAppointments(currentUserData.appointments || []);
              renderProducts(currentUserData.products || []);
              renderOffers(currentUserData.offers || []);
              renderHistory(currentUserData.history || []);
              renderMonthlySales(currentUserData.monthlySales || []); 
              
              $('totalSales').innerText = (currentUserData.totalSales || 0).toFixed(2);
              
              // Show dashboard
              navEl.classList.remove('hidden'); 
              showTab('appointments', document.querySelector("nav button:nth-child(1)"));
              $('auth').classList.remove('active');
          } else {
              console.log("No user data found in Firestore");
          }
      } catch(e) {
          console.error("Error loading dashboard data:", e);
          alert("Failed to load data. Please check your connection.");
      }
  }

  window.verifyOwnerPin = async function() {
      if (!currentUserUID) return false;
      const inputPin = prompt("Enter Owner Pin to confirm this action:");
      if (!inputPin) return false;
      
      const userDoc = await getDoc(doc(db, "users", currentUserUID));
      if(userDoc.exists() && userDoc.data().pin === inputPin) {
          return true;
      } else {
          alert("Invalid Owner Pin!");
          return false;
      }
  }

  // Appointment Functions
  window.addAppointment = async function(){
      if(!currentUserUID) return alert("Please log in first.");
      let appt = { 
          customer: $('custName').value.trim(), 
          service: $('service').value.trim(), 
          date: $('apptDate').value, 
          time: $('apptTime').value,
          status: 'Pending' 
      };
      if (!appt.customer || !appt.service || !appt.date || !appt.time) return alert("Please fill all appointment details.");
      
      await updateDoc(doc(db, "users", currentUserUID), { 
          appointments: arrayUnion(appt) 
      });
      
      alert("Appointment added.");
      $('custName').value = $('service').value = $('apptDate').value = $('apptTime').value = '';
      loadDashboardData(); 
  }

  window.manageAppointment = async function(date, time, newStatus) {
      if (!currentUserUID) return;

      const appointments = currentUserData.appointments || [];
      const index = appointments.findIndex(a => a.date === date && a.time === time);
      
      if (index === -1) {
          alert("Appointment not found.");
          loadDashboardData();
          return;
      }
      
      // Create updated appointment
      const updatedAppt = { ...appointments[index], status: newStatus };
      
      // Remove old and add updated
      await updateDoc(doc(db, "users", currentUserUID), { 
          appointments: arrayRemove(appointments[index]) 
      });
      await updateDoc(doc(db, "users", currentUserUID), { 
          appointments: arrayUnion(updatedAppt) 
      });
      
      alert(`Appointment status updated to: ${newStatus}`);
      loadDashboardData();
  }

  window.deleteAppointment = async function(date, time) {
      if (!currentUserUID) return;
      if (!await verifyOwnerPin()) return; 
      
      const appointmentToDelete = currentUserData.appointments.find(a => a.date === date && a.time === time);
      if (appointmentToDelete) {
          await updateDoc(doc(db, "users", currentUserUID), { 
              appointments: arrayRemove(appointmentToDelete) 
          });
          alert("Appointment deleted permanently.");
          loadDashboardData();
      }
  }

  // Product Functions
  window.addProduct = async function(){
      if(!currentUserUID) return alert("Please log in first.");
      let name = $('prodName').value.trim();
      let price = +$('prodPrice').value;
      const photoFile = $('prodPhoto').files[0];
      
      if (!name || isNaN(price) || price <= 0) return alert("Invalid Name or Price.");

      let photoURL = null;
      if (photoFile) {
          try {
              photoURL = await fileToBase64(photoFile);
          } catch (e) {
              alert("Image processing failed: " + e.message);
              return;
          }
      }
      
      let prod = { name, price, photoURL }; 
      
      await updateDoc(doc(db, "users", currentUserUID), { 
          products: arrayUnion(prod) 
      });
      
      alert("Product/Service added successfully.");
      $('prodName').value = $('prodPrice').value = '';
      $('prodPhoto').value = null; 
      loadDashboardData(); 
  }

  window.removeProduct = async function(name) {
      if (!currentUserUID) return;
      if (!await verifyOwnerPin()) return; 
      
      const productToRemove = currentUserData.products.find(p => p.name === name);
      if (productToRemove) {
          await updateDoc(doc(db, "users", currentUserUID), { 
              products: arrayRemove(productToRemove) 
          });
          alert("Product/Service removed.");
          loadDashboardData();
      }
  }

  // Offer Functions
  window.addOffer = async function(){
      if(!currentUserUID) return alert("Please log in first.");
      let title = $('offerTitle').value.trim();
      let discount = +$('offerDisc').value;
      const photoFile = $('offerPhoto').files[0];

      if (!title || isNaN(discount) || discount <= 0 || discount >= 100) return alert("Invalid Title or Discount (must be between 1 and 99).");

      let photoURL = null;
      if (photoFile) {
          try {
              photoURL = await fileToBase64(photoFile);
          } catch (e) {
              alert("Image processing failed: " + e.message);
              return;
          }
      }

      let offer = { title, discount, photoURL }; 
      await updateDoc(doc(db, "users", currentUserUID), { 
          offers: arrayUnion(offer) 
      });
      
      alert("Offer added successfully.");
      $('offerTitle').value = $('offerDisc').value = '';
      $('offerPhoto').value = null; 
      loadDashboardData();
  }

  window.removeOffer = async function(title) {
      if (!currentUserUID) return;
      if (!await verifyOwnerPin()) return; 
      
      const offerToRemove = currentUserData.offers.find(o => o.title === title);
      if (offerToRemove) {
          await updateDoc(doc(db, "users", currentUserUID), { 
              offers: arrayRemove(offerToRemove) 
          });
          alert("Offer removed.");
          loadDashboardData();
      }
  }

  // Billing Functions
  window.addBillItem = function() {
      const productSelect = $('billProd');
      const selectedProduct = productSelect.options[productSelect.selectedIndex];
      const productName = selectedProduct.text;
      const productPrice = parseFloat(selectedProduct.value);
      const quantity = parseInt($('billQty').value) || 1;
      
      if (!productName || isNaN(productPrice)) return alert("Please select a product first.");
      
      const total = productPrice * quantity;
      billItems.push({ name: productName, price: productPrice, quantity: quantity, total: total });
      
      // Update bill table
      const billTable = $('billTable');
      const newRow = billTable.insertRow();
      newRow.innerHTML = `
          <td>${productName}</td>
          <td>${quantity}</td>
          <td>${productPrice.toFixed(2)}</td>
          <td>${total.toFixed(2)}</td>
      `;
      
      // Update total
      const currentTotal = billItems.reduce((sum, item) => sum + item.total, 0);
      $('billTotal').innerText = currentTotal.toFixed(2);
      
      $('billQty').value = 1;
  }

  window.saveBill = async function(){
      if(!currentUserUID) return alert("Please log in first.");
      if(billItems.length === 0) return alert("The bill is empty.");
      
      const finalTotal = billItems.reduce((s,i) => s + i.total, 0);
      const customerName = $('billCustName').value.trim() || "Walk-in Customer";
      const customerPhone = $('billCustPhone').value.trim(); 
      const cleanPhone = customerPhone ? customerPhone.replace(/[^0-9]/g, "") : null;
      
      let bill = { 
          customer: customerName,
          phone: cleanPhone, 
          items: billItems, 
          total: finalTotal, 
          date: new Date().toLocaleString() 
      };

      const newTotalSales = (currentUserData.totalSales || 0) + finalTotal;

      // Generate receipt (simple version)
      try {
          let receiptText = `SALON BILL RECEIPT\n`;
          receiptText += `Date: ${new Date().toLocaleString()}\n`;
          receiptText += `Customer: ${customerName}\n`;
          receiptText += `Phone: ${customerPhone}\n\n`;
          receiptText += `ITEMS:\n`;
          billItems.forEach(item => {
              receiptText += `${item.name} x ${item.quantity} = Rs. ${item.total.toFixed(2)}\n`;
          });
          receiptText += `\nTOTAL: Rs. ${finalTotal.toFixed(2)}`;
          
          alert(`Bill of Rs. ${finalTotal.toFixed(2)} saved!\n\n${receiptText}`);
      } catch(error) {
          console.error("Error generating receipt:", error);
          alert("Bill saved successfully!");
      }
      
      // Save to Firebase
      await updateDoc(doc(db, "users", currentUserUID), { 
          bills: arrayUnion(bill),
          history: arrayUnion(bill),
          totalSales: newTotalSales 
      });

      // WhatsApp sharing
      if (cleanPhone && cleanPhone.length >= 10) {
          let msgText = `*Salon Receipt - ${currentUserData.email}*\n\n`;
          msgText += `Customer: ${customerName}\n`;
          msgText += `Date: ${new Date().toLocaleString()}\n\n`;
          msgText += `*Items:*\n`;
          billItems.forEach(item => {
              msgText += `‚Ä¢ ${item.name} x ${item.quantity} = Rs. ${item.total.toFixed(2)}\n`;
          });
          msgText += `\n*Total Amount: Rs. ${finalTotal.toFixed(2)}*\n\n`;
          msgText += `Thank you for your business! üíà`;
          
          const encodedMessage = encodeURIComponent(msgText);
          const waLink = `https://wa.me/${cleanPhone}?text=${encodedMessage}`;
          window.open(waLink, '_blank');
      }

      // Reset bill state
      billItems = []; 
      $('billTable').innerHTML = "<tr><th>Product</th><th>Qty</th><th>Price</th><th>Total</th></tr>";
      $('billTotal').innerText = "0.00";
      $('billCustName').value = $('billCustPhone').value = '';
      $('billReceiptHeader').innerText = `SALON BILL RECEIPT`; 
      
      loadDashboardData();
  }

  // Sales Functions
  window.closeDay = async function() {
      if (!currentUserUID) return alert("Please log in first.");
      if (!await verifyOwnerPin()) return; 

      const currentSales = currentUserData.totalSales || 0;
      if (currentSales === 0) return alert("No sales to close for today/this period.");

      const confirmation = confirm(`Are you sure you want to close the day/period? Sales amount Rs. ${currentSales.toFixed(2)} will be archived and the current total will be reset to 0.`);
      if (!confirmation) return;
      
      const salesRecord = {
          date: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }),
          amount: currentSales
      };

      await updateDoc(doc(db, "users", currentUserUID), { 
          monthlySales: arrayUnion(salesRecord),
          totalSales: 0 
      });
      
      alert(`Day closed successfully! Sales of Rs. ${currentSales.toFixed(2)} archived.`);
      loadDashboardData();
  }

  window.generatePDFStatement = function() {
      if (!currentUserUID) return alert("Please log in first.");
      
      const monthlySales = currentUserData.monthlySales || [];
      if (monthlySales.length === 0) return alert("No sales data available for PDF generation.");
      
      let statementText = `SALON MANAGER PRO - SALES STATEMENT\n`;
      statementText += `Generated on: ${new Date().toLocaleString()}\n`;
      statementText += `User: ${currentUserData.email}\n\n`;
      statementText += `MONTHLY SALES HISTORY:\n\n`;
      
      let totalAllSales = 0;
      monthlySales.forEach(sale => {
          statementText += `${sale.date}: Rs. ${sale.amount.toFixed(2)}\n`;
          totalAllSales += sale.amount;
      });
      
      statementText += `\nTOTAL ARCHIVED SALES: Rs. ${totalAllSales.toFixed(2)}\n`;
      statementText += `CURRENT SALES: Rs. ${(currentUserData.totalSales || 0).toFixed(2)}\n`;
      statementText += `GRAND TOTAL: Rs. ${(totalAllSales + (currentUserData.totalSales || 0)).toFixed(2)}`;
      
      alert(`Sales Statement:\n\n${statementText}\n\nYou can copy this text and save it manually.`);
  }

  // Offer Sharing
  window.shareOfferPopup = function(title, discount, photoURL) {
      const shopName = currentUserData.email || "Your Salon";
      const shareText = `*New Offer at ${shopName}!* üî•\n\nüéâ ${title}\nDiscount: *${discount}% OFF* on selected services!\n\nVisit us today!`;
      
      const encodedMessage = encodeURIComponent(shareText);
      const waLink = `https://wa.me/?text=${encodedMessage}`;
      window.open(waLink, '_blank');
  };

  // Rendering Functions
  function renderAppointments(appointments) {
      const table = $('apptTable');
      table.innerHTML = `<tr><th>Customer</th><th>Service</th><th>Date</th><th>Time</th><th>Status</th><th>Delete</th></tr>`;
      
      appointments.sort((a, b) => new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time))
                  .forEach(appt => {
          const row = table.insertRow();
          row.innerHTML = `
              <td>${appt.customer}</td>
              <td>${appt.service}</td>
              <td>${appt.date}</td>
              <td>${appt.time}</td>
              <td>
                  <select class="status-select" onchange="manageAppointment('${appt.date}', '${appt.time}', this.value)">
                      <option value="Pending" ${appt.status === 'Pending' ? 'selected' : ''}>Pending</option>
                      <option value="Confirmed" ${appt.status === 'Confirmed' ? 'selected' : ''}>Confirmed</option>
                      <option value="Completed" ${appt.status === 'Completed' ? 'selected' : ''}>Completed</option>
                      <option value="Cancelled" ${appt.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                  </select>
              </td>
              <td>
                  <button class="delete-btn" onclick="deleteAppointment('${appt.date}', '${appt.time}')">‚ùå</button>
              </td>
          `;
      });
  }

  function renderProducts(products) {
      const feed = $('prodFeed');
      const billSelect = $('billProd');
      
      feed.innerHTML = '';
      billSelect.innerHTML = '<option value="">Select Product</option>';
      
      products.forEach(prod => {
          // Add to feed
          const card = document.createElement('div');
          card.className = 'feed-card';
          card.innerHTML = `
              ${prod.photoURL ? `<img src="${prod.photoURL}" class="feed-image" alt="${prod.name}">` : '<div class="feed-image" style="background:#f0f2f5; display:flex; align-items:center; justify-content:center;">üì¶</div>'}
              <div style="flex:1;">
                  <h4 style="margin:0 0 5px 0;">${prod.name}</h4>
                  <p style="margin:0; color:var(--success-green); font-weight:bold;">Rs. ${prod.price.toFixed(2)}</p>
              </div>
              <div class="feed-actions">
                  <button class="delete-btn" onclick="removeProduct('${prod.name}')">Delete</button>
              </div>
          `;
          feed.appendChild(card);
          
          // Add to billing dropdown
          const option = document.createElement('option');
          option.value = prod.price;
          option.textContent = `${prod.name} - Rs. ${prod.price.toFixed(2)}`;
          billSelect.appendChild(option);
      });
  }

  function renderOffers(offers) {
      const feed = $('offerFeed');
      feed.innerHTML = '';
      
      offers.forEach(offer => {
          const card = document.createElement('div');
          card.className = 'feed-card';
          card.innerHTML = `
              ${offer.photoURL ? `<img src="${offer.photoURL}" class="feed-image" alt="${offer.title}">` : '<div class="feed-image" style="background:#f0f2f5; display:flex; align-items:center; justify-content:center;">üéÅ</div>'}
              <div style="flex:1;">
                  <h4 style="margin:0 0 5px 0;">${offer.title}</h4>
                  <p style="margin:0; color:var(--danger-red); font-weight:bold;">${offer.discount}% OFF</p>
              </div>
              <div class="feed-actions">
                  <button class="share-btn" onclick="shareOfferPopup('${offer.title}', '${offer.discount}', '${offer.photoURL || ''}')">Share</button>
                  <button class="delete-btn" onclick="removeOffer('${offer.title}')">Delete</button>
              </div>
          `;
          feed.appendChild(card);
      });
  }

  function renderHistory(history) {
      const table = $('histTable');
      table.innerHTML = `<tr><th>Customer</th><th>Phone</th><th>Total Bill</th><th>Date</th></tr>`;
      
      // Get unique customers
      const customers = {};
      history.forEach(bill => {
          if (!customers[bill.customer]) {
              customers[bill.customer] = {
                  phone: bill.phone,
                  totalSpent: 0,
                  lastVisit: bill.date
              };
          }
          customers[bill.customer].totalSpent += bill.total;
          if (new Date(bill.date) > new Date(customers[bill.customer].lastVisit)) {
              customers[bill.customer].lastVisit = bill.date;
          }
      });
      
      // Render customer list
      const customerList = $('customerList');
      customerList.innerHTML = '';
      Object.keys(customers).forEach(customer => {
          const div = document.createElement('div');
          div.className = 'feed-card';
          div.innerHTML = `
              <div style="flex:1;">
                  <h4 style="margin:0 0 5px 0;">${customer}</h4>
                  <p style="margin:0; font-size:12px;">Phone: ${customers[customer].phone || 'N/A'}</p>
                  <p style="margin:0; font-size:12px;">Total Spent: Rs. ${customers[customer].totalSpent.toFixed(2)}</p>
                  <p style="margin:0; font-size:12px;">Last Visit: ${customers[customer].lastVisit}</p>
              </div>
          `;
          customerList.appendChild(div);
      });
      
      // Render transaction history
      history.sort((a, b) => new Date(b.date) - new Date(a.date))
            .forEach(bill => {
          const row = table.insertRow();
          row.innerHTML = `
              <td>${bill.customer}</td>
              <td>${bill.phone || 'N/A'}</td>
              <td>Rs. ${bill.total.toFixed(2)}</td>
              <td>${bill.date}</td>
          `;
      });
  }

  function renderMonthlySales(monthlySales) {
      const table = $('monthlySalesTable');
      table.innerHTML = `<tr><th>Date</th><th>Sales Amount</th></tr>`;
      
      monthlySales.sort((a, b) => new Date(b.date) - new Date(a.date))
                 .forEach(sale => {
          const row = table.insertRow();
          row.innerHTML = `
              <td>${sale.date}</td>
              <td>Rs. ${sale.amount.toFixed(2)}</td>
          `;
      });
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', function() {
      navEl = $('mainNav');
      
      // Set today's date as default for appointment date
      const today = new Date().toISOString().split('T')[0];
      $('apptDate').value = today;
      
      // Set current time as default for appointment time
      const now = new Date();
      const hours = now.getHours().toString().padStart(2, '0');
      const minutes = now.getMinutes().toString().padStart(2, '0');
      $('apptTime').value = `${hours}:${minutes}`;
  });

  // File preview handlers
  $('prodPhoto').addEventListener('change', function(e) {
      const file = e.target.files[0];
      const preview = $('prodPhotoPreview');
      if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
              preview.src = e.target.result;
              preview.classList.remove('hidden');
          }
          reader.readAsDataURL(file);
      } else {
          preview.classList.add('hidden');
      }
  });

  $('offerPhoto').addEventListener('change', function(e) {
      const file = e.target.files[0];
      const preview = $('offerPhotoPreview');
      if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
              preview.src = e.target.result;
              preview.classList.remove('hidden');
          }
          reader.readAsDataURL(file);
      } else {
          preview.classList.add('hidden');
      }
  });
</script>
</body>
</html>