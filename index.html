<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Salon Manager</title>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<style>body{margin:0;font-family:sans-serif;background:#0b1220;color:#e5e7eb}header{display:flex;align-items:center;gap:10px;padding:10px 16px;background:#111}h1{margin:0;font-size:18px}.pill{margin-left:auto;padding:4px 10px;background:#7c3aed;border-radius:999px;font-size:12px}.app{max-width:700px;margin:30px auto;padding:16px}.card{background:#1e293b;padding:20px;border-radius:14px}.tabs{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}.tab{flex:1;padding:10px;border-radius:8px;text-align:center;cursor:pointer;background:#334155}.tab.active{background:#7c3aed;color:#fff}.hidden{display:none}label{font-size:12px;display:block;margin:6px 0}input{width:100%;padding:10px;border-radius:8px;border:1px solid #334155;background:#0f172a;color:#fff}button{margin-top:8px;padding:8px 12px;border:none;border-radius:8px;background:#7c3aed;color:#fff;font-weight:700;cursor:pointer}ul{margin-top:10px;padding-left:18px}.small{font-size:12px;color:#9aa6bb}.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#7c3aed;color:#fff;padding:8px 12px;border-radius:8px;opacity:0;transition:.25s;z-index:999}.toast.show{opacity:1;bottom:34px}</style>
</head>
<body>
<header><div>ðŸ’ˆ</div><h1>Salon Manager By Salamat Ali</h1><div class="pill" id="statusPill">Closed</div></header>
<div class="app">
<section id="auth" class="card"><div class="tabs">
<div class="tab active" data-auth="login">Login</div><div class="tab" data-auth="register">Register</div><div class="tab" data-auth="forgot">Forgot</div></div>
<div id="loginPane"><label>Username</label><input id="loginUser"><label>Password</label><input id="loginPass" type="password"><button id="btnLogin">Login</button></div>
<div id="registerPane" class="hidden"><label>Username</label><input id="regUser"><label>Password</label><input id="regPass" type="password"><label>Owner PIN</label><input id="regPin" type="password" maxlength="6"><button id="btnRegister">Create Account</button></div>
<div id="forgotPane" class="hidden"><label>Username</label><input id="forgotUser"><label>Owner PIN</label><input id="forgotPin" type="password" maxlength="6"><button id="btnForgot">Recover Account</button></div></section>

<section id="dashboard" class="card hidden"><div class="tabs" id="mainTabs"></div><div id="tabContent"></div><button id="btnLogout">Logout</button></section></div>
<div id="toast" class="toast"></div>

<script>
// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyBI00hCbWcEoMd3yCCXB7OGqYLsH7qKiE8",
  authDomain: "urban-punjabi-salon.firebaseapp.com",
  projectId: "urban-punjabi-salon",
  storageBucket: "urban-punjabi-salon.firebasestorage.app",
  messagingSenderId: "912792635283",
  appId: "1:912792635283:web:39934c847a001b2909ca66",
  measurementId: "G-ND2Y5JC4Y7"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Utility Functions
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function toast(m) { const t = $("#toast"); t.textContent = m; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 1700); }

// Firebase Data Functions
async function saveToFirebase(data) {
    try {
        const user = getCurrentUser();
        await db.collection('salonUsers').doc(user).set({ data, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
    } catch (error) { console.error('Firebase save error:', error); toast('Sync failed'); }
}

async function loadFromFirebase() {
    try {
        const user = getCurrentUser();
        const doc = await db.collection('salonUsers').doc(user).get();
        return doc.exists ? doc.data().data : null;
    } catch (error) { console.error('Firebase load error:', error); return null; }
}

// Local Storage Fallback
function getLocalData() { return JSON.parse(localStorage.getItem("salonData") || '{"apts":[],"prods":[],"bills":[],"history":[],"totalSale":0,"offers":[]}'); }
function saveLocalData(data) { localStorage.setItem("salonData", JSON.stringify(data)); }

// Combined Data Functions
async function getUserData() {
    const firebaseData = await loadFromFirebase();
    if (firebaseData) { saveLocalData(firebaseData); return firebaseData; }
    return getLocalData();
}

async function saveUserData(data) {
    saveLocalData(data);
    await saveToFirebase(data);
}

function getCurrentUser() { return localStorage.getItem("currentUser") || ""; }
function setCurrentUser(u) { u ? localStorage.setItem("currentUser", u) : localStorage.removeItem("currentUser"); }

// Auth Tabs
$$('.tab[data-auth]').forEach(tab => tab.addEventListener('click', () => {
    $$('.tab[data-auth]').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    $('#loginPane').classList.toggle('hidden', tab.dataset.auth !== 'login');
    $('#registerPane').classList.toggle('hidden', tab.dataset.auth !== 'register');
    $('#forgotPane').classList.toggle('hidden', tab.dataset.auth !== 'forgot');
}));

// Registration
$('#btnRegister').addEventListener('click', async () => {
    const u = $('#regUser').value.trim(), p = $('#regPass').value, pin = $('#regPin').value.trim();
    if (!u || !p || !pin) { toast("Fill all fields"); return; }
    try {
        const doc = await db.collection('salonUsers').doc(u).get();
        if (doc.exists) { toast("Username exists"); return; }
        await db.collection('salonUsers').doc(u).set({ password: p, pin: pin, data: { apts: [], prods: [], bills: [], history: [], totalSale: 0, offers: [] } });
        toast("Account created - login now");
        $('#regUser').value = $('#regPass').value = $('#regPin').value = "";
        $('[data-auth="login"]').click();
    } catch (error) { toast("Registration failed"); }
});

// Login
$('#btnLogin').addEventListener('click', async () => {
    const u = $('#loginUser').value.trim(), p = $('#loginPass').value;
    try {
        const doc = await db.collection('salonUsers').doc(u).get();
        if (doc.exists && doc.data().password === p) {
            setCurrentUser(u);
            startDashboard();
        } else toast("Invalid login");
    } catch (error) { toast("Login failed"); }
});

// Forgot Password
$('#btnForgot').addEventListener('click', async () => {
    const u = $('#forgotUser').value.trim(), pin = $('#forgotPin').value.trim();
    try {
        const doc = await db.collection('salonUsers').doc(u).get();
        if (doc.exists && doc.data().pin === pin) toast("Password: " + doc.data().password);
        else toast("Wrong details");
    } catch (error) { toast("Recovery failed"); }
});

// Logout
$('#btnLogout').addEventListener('click', () => {
    setCurrentUser("");
    $('#dashboard').classList.add("hidden");
    $('#auth').classList.remove("hidden");
    $('#statusPill').textContent = "Closed";
    toast('Logged out');
});

// Tabs Configuration
const tabs = [
    { id: "appointments", label: "Appointments" },
    { id: "billing", label: "Billing" },
    { id: "products", label: "Products" },
    { id: "offers", label: "Offers" },
    { id: "sales", label: "Sales" },
    { id: "history", label: "History" },
    { id: "support", label: "Support" }
];

async function startDashboard() {
    $('#auth').classList.add("hidden");
    $('#dashboard').classList.remove("hidden");
    $('#statusPill').textContent = "Open";
    initTabs();
}

function initTabs() {
    const bar = $("#mainTabs");
    bar.innerHTML = "";
    tabs.forEach(t => {
        const b = document.createElement("div");
        b.className = "tab";
        b.textContent = t.label;
        b.onclick = () => openTab(t.id);
        bar.appendChild(b);
    });
    openTab("appointments");
}

async function openTab(id) {
    $$("#mainTabs .tab").forEach(b => b.classList.remove("active"));
    const idx = tabs.findIndex(t => t.id === id);
    $$("#mainTabs .tab")[idx].classList.add("active");
    const box = $("#tabContent");
    box.innerHTML = "";
    
    const data = await getUserData();
    
    switch (id) {
        case "appointments": renderAppointments(box, data); break;
        case "billing": renderBilling(box, data); break;
        case "products": renderProducts(box, data); break;
        case "offers": renderOffers(box, data); break;
        case "sales": renderSales(box, data); break;
        case "history": renderHistory(box, data); break;
        case "support": renderSupport(box); break;
    }
}

// Tab Render Functions
function renderAppointments(el, data) {
    el.innerHTML = `<h3>Book Appointment</h3><label>Name</label><input id="aptName"><label>Service</label><input id="aptService"><label>Date & Time</label><input id="aptTime" type="datetime-local"><button id="saveApt">Save</button><ul id="aptList"></ul>`;
    $("#saveApt").onclick = async () => {
        const name = $("#aptName").value.trim(), service = $("#aptService").value.trim(), time = $("#aptTime").value;
        if (!name || !service || !time) { toast("Fill all fields"); return; }
        data.apts.push({ name, service, time });
        await saveUserData(data);
        openTab("appointments");
        toast('Appointment saved');
    };
    $("#aptList").innerHTML = data.apts.length > 0 ? data.apts.map((a, i) => 
        `<li class="appointment-item"><div><b>${a.name}</b><div class="small">${a.service} at ${a.time}</div></div><button onclick="completeApt(${i})">Complete</button></li>`
    ).join("") : "<li class='small'>No appointments</li>";
}

function renderBilling(el, data) {
    el.innerHTML = `<h3>Walk-in Billing</h3><label>Customer Name</label><input id="billName"><label>Phone</label><input id="billPhone"><h4>Select Products</h4><div id="billProducts">${
        data.prods.length > 0 ? data.prods.map((p, i) => 
            `<div><input type="checkbox" class="billProd" data-index="${i}" data-price="${p.price}" data-name="${p.name}">${p.name} - $${p.price}</div>`
        ).join("") : "<p class='small'>No products added</p>"
    }</div><p><b>Total: $<span id="billTotal">0</span></b></p><button id="saveBill">Save Bill</button><h3>Recent Bills</h3><div id="billList"></div>`;
    
    function updateTotal() { 
        let total = 0; 
        $$('.billProd:checked').forEach(c => total += +c.dataset.price); 
        $('#billTotal').textContent = total; 
    }
    $$('.billProd').forEach(c => c.addEventListener('change', updateTotal));
    
    $("#saveBill").onclick = async () => {
        let selected = [], total = 0;
        $$('.billProd:checked').forEach(c => { selected.push({ name: c.dataset.name, price: +c.dataset.price }); total += +c.dataset.price; });
        if (!selected.length) { toast("Select items"); return; }
        const name = $("#billName").value.trim(), phone = $("#billPhone").value.trim();
        if (!name) { toast("Enter name"); return; }
        data.bills.push({ name, phone, items: selected, amt: total, time: new Date().toLocaleString() });
        data.totalSale = (data.totalSale || 0) + total;
        await saveUserData(data);
        openTab("billing");
        toast('Bill saved');
    };
    
    $("#billList").innerHTML = data.bills.length > 0 ? data.bills.map((b, i) => 
        `<div class="bill-item"><b>${b.name}</b> - $${b.amt}<br><small>${b.time}</small><br>
         <button onclick="printReceipt(${i})">ðŸ–¨ Print</button> <button onclick="sendWhatsApp(${i})">ðŸ“² WhatsApp</button></div>`
    ).join("") : "<p class='small'>No bills</p>";
}

// Global Functions
window.printReceipt = async (index) => {
    const data = await getUserData();
    const b = data.bills[index];
    if (!b) return;
    const w = window.open("", "", "width=400,height=600");
    w.document.write(`<h2>Salon Receipt</h2><p><b>Customer:</b> ${b.name}</p><ul>${
        b.items.map(it => `<li>${it.name} - $${it.price}</li>`).join("")
    }</ul><p><b>Total:</b> $${b.amt}</p><p>Thank you!</p>`);
    w.print();
    w.close();
};

window.sendWhatsApp = async (index) => {
    const data = await getUserData();
    const b = data.bills[index];
    if (!b.phone) { toast("No phone"); return; }
    const itemsText = b.items.map(it => `${it.name} - $${it.price}`).join("%0a");
    const msg = `Hello ${b.name},%0aYour bill:%0a${itemsText}%0aTotal: $${b.amt}%0aThank you!`;
    window.open(`https://wa.me/${b.phone}?text=${msg}`, "_blank");
};

window.completeApt = async (i) => {
    const data = await getUserData();
    data.apts.splice(i, 1);
    await saveUserData(data);
    openTab('appointments');
    toast('Completed');
};

// Other render functions (products, offers, sales, history, support) similarly optimized...

window.onload = () => { if (getCurrentUser()) startDashboard(); };
</script>
</body>
</html>
