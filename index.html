<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Salon Manager</title>
<style>
body{margin:0;font-family:sans-serif;background:#0b1220;color:#e5e7eb;}
header{display:flex;align-items:center;gap:10px;padding:10px 16px;background:#111;}
header h1{margin:0;font-size:18px;font-weight:700}
.pill{margin-left:auto;padding:4px 10px;background:#7c3aed;border-radius:999px;font-size:12px}
.app{max-width:700px;margin:30px auto;padding:16px}
.card{background:#1e293b;padding:20px;border-radius:14px}
.tabs{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}
.tab{flex:1;padding:10px;border-radius:8px;text-align:center;cursor:pointer;background:#334155}
.tab.active{background:#7c3aed;color:#fff}
.hidden{display:none}
label{font-size:12px;display:block;margin:6px 0}
input{width:100%;padding:10px;border-radius:8px;border:1px solid:#334155;background:#0f172a;color:#fff}
button{margin-top:8px;padding:8px 12px;border:none;border-radius:8px;background:#7c3aed;color:#fff;font-weight:700;cursor:pointer}
ul{margin-top:10px;padding-left:18px}
img{border-radius:6px;max-width:100%}
.offer-item{display:flex;align-items:center;gap:10px;margin-bottom:15px;padding:10px;background:#2d3748;border-radius:8px;}
.offer-photo{width:60px;height:60px;object-fit:cover;border-radius:8px;}
.offer-info{flex:1;}
.offer-actions{display:flex;gap:5px;}
.btn-whatsapp{background:#25D366;color:white;}
.photo-preview{width:100px;height:100px;object-fit:cover;border-radius:8px;margin:10px 0;}
.customer-selector{max-height:200px;overflow-y:auto;margin:10px 0;padding:10px;background:#2d3748;border-radius:8px;}
.bill-item{margin-bottom:15px;padding:10px;background:#2d3748;border-radius:8px;}
.appointment-item{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding:10px;background:#2d3748;border-radius:8px;}
.small{font-size:12px;color:#9aa6bb}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#7c3aed;color:#fff;padding:8px 12px;border-radius:8px;opacity:0;transition:.25s;z-index:999}
.toast.show{opacity:1;bottom:34px}
.feed{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-top:12px}
.item-card{background:#0f1724;padding:10px;border-radius:8px}
</style>
</head>
<body>
<header>
<div>ðŸ’ˆ</div>
<h1>Salon Manager By Salamat Ali</h1>
<div class="pill" id="statusPill">Closed</div>
</header>
<div class="app">
<section id="auth" class="card">
<div class="tabs">
<div class="tab active" data-auth="login">Login</div>
<div class="tab" data-auth="register">Register</div>
<div class="tab" data-auth="forgot">Forgot</div>
</div>
<div id="loginPane">
<label>Username</label><input id="loginUser" type="text" />
<label>Password</label><input id="loginPass" type="password" />
<button id="btnLogin">Login</button>
</div>
<div id="registerPane" class="hidden">
<label>Username</label><input id="regUser" type="text" />
<label>Password</label><input id="regPass" type="password" />
<label>Owner PIN</label><input id="regPin" type="password" maxlength="6" />
<button id="btnRegister">Create Account</button>
</div>
<div id="forgotPane" class="hidden">
<label>Username</label><input id="forgotUser" type="text" />
<label>Owner PIN</label><input id="forgotPin" type="password" maxlength="6" />
<button id="btnForgot">Recover Account</button>
</div>
</section>

<section id="dashboard" class="card hidden">
<div class="tabs" id="mainTabs"></div>
<div id="tabContent"></div>
<button id="btnLogout">Logout</button>
</section>
</div>

<div id="toast" class="toast"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
// Firebase Configuration - YEH USE KAREIN
const firebaseConfig = {
  apiKey: "AIzaSyBI00hCbWcEoMd3yCCXB7OGqYLsH7qKiE8",
  authDomain: "urban-punjabi-salon.firebaseapp.com",
  projectId: "urban-punjabi-salon",
  storageBucket: "urban-punjabi-salon.firebasestorage.app",
  messagingSenderId: "912792635283",
  appId: "1:912792635283:web:39934c847a001b2909ca66",
  measurementId: "G-ND2Y5JC4Y7"
};

// Initialize Firebase
try {
    firebase.initializeApp(firebaseConfig);
} catch (error) {
    console.log('Firebase already initialized');
}
const db = firebase.firestore();

// Utility Functions
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function toast(m) { const t = $("#toast"); t.textContent = m; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 1700); }

// Firebase Data Functions
async function saveToFirebase(data) {
    try {
        const user = getCurrentUser();
        await db.collection('users').doc(user).set({ 
            data: data, 
            lastUpdated: new Date().toISOString() 
        }, { merge: true });
        return true;
    } catch (error) { 
        console.error('Firebase save error:', error);
        return false;
    }
}

async function loadFromFirebase() {
    try {
        const user = getCurrentUser();
        const doc = await db.collection('users').doc(user).get();
        if (doc.exists) {
            return doc.data().data;
        }
        return null;
    } catch (error) { 
        console.error('Firebase load error:', error);
        return null;
    }
}

// Local Storage Fallback
function getLocalData() { 
    const user = getCurrentUser();
    return JSON.parse(localStorage.getItem(`salonData_${user}`) || '{"apts":[],"prods":[],"bills":[],"history":[],"totalSale":0,"offers":[]}'); 
}

function saveLocalData(data) { 
    const user = getCurrentUser();
    localStorage.setItem(`salonData_${user}`, JSON.stringify(data)); 
}

// Combined Data Functions
async function getUserData() {
    // Pehle Firebase se try karein
    const firebaseData = await loadFromFirebase();
    if (firebaseData) {
        saveLocalData(firebaseData); // Local backup
        return firebaseData;
    }
    
    // Agar Firebase fail ho to local storage use karein
    return getLocalData();
}

async function saveUserData(data) {
    // Local storage mein immediately save karein
    saveLocalData(data);
    
    // Firebase mein bhi save karein (background mein)
    const firebaseSuccess = await saveToFirebase(data);
    if (!firebaseSuccess) {
        toast('Data saved locally (offline)');
    }
}

// Authentication Functions
async function registerUser(username, password, pin) {
    try {
        // Check if user already exists
        const doc = await db.collection('users').doc(username).get();
        if (doc.exists) {
            return { success: false, message: "Username already exists" };
        }
        
        // Create new user
        const userData = {
            password: password,
            pin: pin,
            data: { apts: [], prods: [], bills: [], history: [], totalSale: 0, offers: [] },
            createdAt: new Date().toISOString()
        };
        
        await db.collection('users').doc(username).set(userData);
        return { success: true, message: "Account created successfully!" };
    } catch (error) {
        console.error('Registration error:', error);
        return { success: false, message: "Registration failed. Try again." };
    }
}

async function loginUser(username, password) {
    try {
        const doc = await db.collection('users').doc(username).get();
        if (doc.exists && doc.data().password === password) {
            return { success: true };
        }
        return { success: false, message: "Invalid username or password" };
    } catch (error) {
        console.error('Login error:', error);
        return { success: false, message: "Login failed. Try again." };
    }
}

async function recoverPassword(username, pin) {
    try {
        const doc = await db.collection('users').doc(username).get();
        if (doc.exists && doc.data().pin === pin) {
            return { success: true, password: doc.data().password };
        }
        return { success: false, message: "Invalid username or PIN" };
    } catch (error) {
        return { success: false, message: "Recovery failed" };
    }
}

function getCurrentUser() { return localStorage.getItem("currentUser") || ""; }
function setCurrentUser(u) { u ? localStorage.setItem("currentUser", u) : localStorage.removeItem("currentUser"); }

// Rest of your existing code (tabs, rendering functions) yahan paste karein
// [Yahan aapka original code ka remaining part ayega]

// Auth Tabs
$$('.tab[data-auth]').forEach(tab => tab.addEventListener('click', () => {
    $$('.tab[data-auth]').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    $('#loginPane').classList.toggle('hidden', tab.dataset.auth !== 'login');
    $('#registerPane').classList.toggle('hidden', tab.dataset.auth !== 'register');
    $('#forgotPane').classList.toggle('hidden', tab.dataset.auth !== 'forgot');
}));

// Registration
$('#btnRegister').addEventListener('click', async () => {
    const u = $('#regUser').value.trim(), p = $('#regPass').value, pin = $('#regPin').value.trim();
    if (!u || !p || !pin) { toast("Please fill all fields"); return; }
    
    const result = await registerUser(u, p, pin);
    toast(result.message);
    
    if (result.success) {
        $('#regUser').value = $('#regPass').value = $('#regPin').value = "";
        document.querySelector('[data-auth="login"]').click();
    }
});

// Login
$('#btnLogin').addEventListener('click', async () => {
    const u = $('#loginUser').value.trim(), p = $('#loginPass').value;
    
    const result = await loginUser(u, p);
    if (result.success) {
        setCurrentUser(u);
        startDashboard();
    } else {
        toast(result.message || "Invalid login");
    }
});

// Forgot Password
$('#btnForgot').addEventListener('click', async () => {
    const u = $('#forgotUser').value.trim(), pin = $('#forgotPin').value.trim();
    
    const result = await recoverPassword(u, pin);
    if (result.success) {
        toast("Your password: " + result.password);
    } else {
        toast(result.message || "Wrong details");
    }
});

// Logout
$('#btnLogout').addEventListener('click', () => {
    setCurrentUser("");
    $('#dashboard').classList.add("hidden");
    $('#auth').classList.remove("hidden");
    $('#statusPill').textContent = "Closed";
    toast('Logged out');
});

const tabs = [
    {id:"appointments",label:"Appointments"},
    {id:"billing",label:"Billing"},
    {id:"products",label:"Products & Services"},
    {id:"offers",label:"Offers"},
    {id:"sales",label:"Sales"},
    {id:"history",label:"History"},
    {id:"support",label:"Support"}
];

async function startDashboard() {
    $('#auth').classList.add("hidden");
    $('#dashboard').classList.remove("hidden");
    $('#statusPill').textContent = "Open";
    checkExpiredOffers();
    initTabs();
}

function initTabs() {
    const bar = $("#mainTabs");
    bar.innerHTML = "";
    tabs.forEach(t => {
        const b = document.createElement("div");
        b.className = "tab";
        b.textContent = t.label;
        b.onclick = () => openTab(t.id);
        bar.appendChild(b);
    });
    openTab("appointments");
}

async function openTab(id) {
    $$("#mainTabs .tab").forEach(b => b.classList.remove("active"));
    const idx = tabs.findIndex(t => t.id === id);
    $$("#mainTabs .tab")[idx].classList.add("active");
    const box = $("#tabContent");
    box.innerHTML = "";
    
    const data = await getUserData();
    
    switch(id) {
        case "appointments": renderAppointments(box, data); break;
        case "billing": renderBilling(box, data); break;
        case "products": renderProducts(box, data); break;
        case "offers": checkExpiredOffers(); renderOffers(box, data); break;
        case "sales": renderSales(box, data); break;
        case "history": renderHistory(box, data); break;
        case "support": renderSupport(box); break;
    }
}

// [Yahan aapke saare render functions rahenge - appointments, billing, products, etc.]

function renderAppointments(el, data) {
    if(!data.apts) data.apts = [];
    el.innerHTML = `<h3>Book Appointment</h3><label>Name</label><input id="aptName" type="text"><label>Service</label><input id="aptService" type="text"><label>Date & Time</label><input id="aptTime" type="datetime-local"><button id="saveApt">Save</button><ul id="aptList"></ul>`;
    
    $("#saveApt").onclick = async () => {
        const name = $("#aptName").value.trim(), service = $("#aptService").value.trim(), time = $("#aptTime").value;
        if(!name || !service || !time) { toast("Please fill all fields"); return; }
        data.apts.push({name, service, time});
        await saveUserData(data);
        openTab("appointments");
        toast('Appointment saved');
    };
    
    $("#aptList").innerHTML = data.apts.length > 0 ? 
        data.apts.map((a,i) => `<li class="appointment-item"><div><b>${a.name}</b><div class="small">${a.service} at ${a.time}</div></div><button onclick="completeApt(${i})">Complete</button></li>`).join("") 
        : "<li class='small'>No appointments booked yet</li>";
}

// [Baki ke render functions yahan add karein...]

window.completeApt = async function(i) {
    const data = await getUserData();
    data.apts.splice(i,1);
    await saveUserData(data);
    openTab('appointments');
    toast('Completed');
}

// [Aapke saare original functions yahan rahenge]

window.onload = () => {
    if(getCurrentUser()) {
        startDashboard();
    }
}
</script>
</body>
  </html>
