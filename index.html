<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Salon Manager Pro (Salamat Ali)</title>
<style>
/* --- CSS (Minor adjustments for table status) --- */
:root {
    --primary-blue: #1877f2; 
    --light-bg: #f0f2f5;    
    --card-bg: #ffffff;
    --text-color: #050505;
    --border-color: #dddfe2;
    --success-green: #38a169;
    --danger-red: #fa383e;
}
body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--light-bg);
    color: var(--text-color);
}
header {
    background: var(--card-bg);
    color: var(--primary-blue);
    padding: 15px 20px;
    text-align: center;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    position: sticky;
    top: 0;
    z-index: 1000;
}
header h1 {
    margin: 0;
    font-size: 24px;
}
nav {
    background: var(--card-bg);
    padding: 0;
    display: flex;
    overflow-x: auto;
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 15px;
}
nav button {
    flex-shrink: 0;
    padding: 12px 15px;
    background: transparent;
    border: none;
    color: #606770;
    cursor: pointer;
    transition: background 0.3s, color 0.3s;
    font-size: 14px;
    border-bottom: 2px solid transparent;
}
nav button.action {
    background: var(--primary-blue);
    color: white;
    margin-left: auto;
    border-radius: 6px;
    margin-right: 15px;
}
nav button.active {
    color: var(--primary-blue);
    border-bottom: 2px solid var(--primary-blue);
    background: var(--light-bg);
}
nav button:not(.active):hover:not(.action) {
    background: #f0f2f5;
    color: var(--text-color);
}
section {
    padding: 20px;
    display: none;
    max-width: 800px;
    margin: 20px auto;
}
section.active {
    display: block;
    background: var(--card-bg);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}
h2 {
    color: var(--primary-blue);
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 10px;
    margin-top: 0;
    font-size: 20px;
}
h3 {
    color: #606770;
}
input, select {
    padding: 10px;
    margin: 8px 0;
    width: calc(100% - 20px);
    box-sizing: border-box;
    border: 1px solid var(--border-color);
    background: var(--card-bg);
    color: var(--text-color);
    border-radius: 6px;
}
button.action {
    padding: 10px 18px;
    margin-top: 10px;
    background: var(--primary-blue);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.2s;
}
button.action:hover {
    background: #1660b4;
}
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    border-radius: 8px;
    overflow: hidden;
}
th, td {
    border: 1px solid var(--border-color);
    padding: 12px 10px;
    text-align: left;
}
th {
    background: var(--light-bg);
    color: #606770;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 12px;
}
.row-actions button {
    padding: 5px 10px;
    background: var(--danger-red); 
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    margin-left: 5px;
}
.row-actions .share-btn {
    background: var(--success-green); 
}
.row-actions .share-btn:hover {
    background: #128c7e;
}

/* Appointment Status Styling */
.status-select {
    padding: 5px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--card-bg);
    width: 100%;
}
.delete-btn {
    background: var(--danger-red);
    color: white;
    padding: 5px 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    display: none; 
}
.delete-btn:hover {
    background: #c9302c;
}

/* --- Other Sections CSS (kept short for brevity) --- */
.hidden { display: none !important; }
.scrollable-feed {
    display: flex;
    flex-direction: column;
    gap: 15px;
    max-height: 70vh; 
    overflow-y: auto;
    padding-right: 5px; 
}
.feed-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    display: flex;
    gap: 15px;
    align-items: center;
}
.feed-image {
    width: 80px;
    height: 80px;
    border-radius: 4px;
    object-fit: cover;
    border: 1px solid var(--border-color);
    flex-shrink: 0;
}
.feed-actions {
    flex-shrink: 0;
    display: flex; 
    gap: 5px;
}

/* --- BILL RECEIPT CONTAINER (For html2canvas) --- */
#billReceipt {
    padding: 15px;
    background: var(--card-bg);
    border: 1px dashed #606770;
    margin-bottom: 15px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 14px;
}
#billReceipt h3, #billReceipt table {
    margin: 5px 0;
}
#billReceipt h3 {
    text-align: center;
    color: var(--primary-blue);
}
#billReceipt table {
    width: 100%;
}
#billReceipt th, #billReceipt td {
    padding: 5px 0;
    border: none;
    border-bottom: 1px dotted #ccc;
    font-size: 13px;
    vertical-align: top;
}
</style>
</head>
<body>

<header>
  <h1>Salon Manager Pro (Salamat Ali) üíá‚Äç‚ôÇÔ∏è</h1>
</header>

<nav id="mainNav" class="hidden">
  <button onclick="showTab('appointments', this)">Appointments</button>
  <button onclick="showTab('products', this)">Products</button>
  <button onclick="showTab('offers', this)">Offers</button>
  <button onclick="showTab('billing', this)">Billing</button>
  <button onclick="showTab('sales', this)">Sales</button>
  <button onclick="showTab('history', this)">Customers & History</button>
  <button class="action" onclick="logoutUser()">Logout</button>
</nav>

<section id="auth" class="active">
  <h2>Access Control</h2>
  <div id="loginForm">
    <h3>Existing User (Login)</h3>
    <input id="logUser" placeholder="Username">
    <input id="logPass" type="password" placeholder="Password">
    <button class="action" onclick="loginUser()">Login</button>
    <div style="text-align: center; margin-top: 15px;">
        <button class="auth-link-button" onclick="showForgot()">Forgot Password?</button>
        <hr style="border-color:var(--border-color); margin:10px 0;">
        <button class="action" onclick="showRegister()">Register New Account</button>
    </div>
  </div>
  <div id="registerForm" class="hidden">
    <h3>New Account (Register)</h3>
    <input id="regUser" placeholder="Username">
    <input id="regPass" type="password" placeholder="Password">
    <input id="regPin" placeholder="Owner Pin" maxlength="6">
    <button class="action" onclick="registerUser()">Register</button>
    <button class="auth-link-button" onclick="showLogin()">‚Üê Back to Login</button>
  </div>
  <div id="forgotForm" class="hidden">
    <h3>Forgot Password</h3>
    <input id="fpUser" placeholder="Username">
    <input id="fpPin" placeholder="Owner Pin" maxlength="6">
    <button class="action" onclick="forgotPassword()">Recover Password</button>
    <button class="auth-link-button" onclick="showLogin()">‚Üê Back to Login</button>
  </div>
</section>

<section id="appointments">
  <h2>Book New Appointment üìÖ</h2>
  <div class="form-row">
    <input id="custName" placeholder="Customer Name">
    <input id="service" placeholder="Service (e.g., Haircut)">
  </div>
  <div class="form-row">
    <input id="apptDate" type="date">
    <input id="apptTime" type="time">
  </div>
  <button class="action" onclick="addAppointment()">Add Appointment</button>
  
  <h3>Upcoming Appointments</h3>
  <table id="apptTable">
    <tr><th>Customer</th><th>Service</th><th>Date</th><th>Time</th><th>Status</th><th>Delete</th></tr> 
  </table>
</section>

<section id="products">
  <h2>Products & Services üõçÔ∏è</h2>
  <div class="form-row">
    <input id="prodName" placeholder="Name">
    <input id="prodPrice" type="number" placeholder="Price">
  </div>
  <div class="form-group">
    <label>Product Image (Optional)</label>
    <input id="prodPhoto" type="file" accept="image/*">
    <img id="prodPhotoPreview" class="photo-preview hidden" src="" alt="Product Preview">
  </div>
  <button class="action" onclick="addProduct()">Add Product/Service</button>
  
  <h3>Current Price List (Scrollable Feed)</h3>
  <div id="prodFeed" class="scrollable-feed">
    </div>
</section>

<section id="offers">
  <h2>Active Offers üéÅ</h2>
  <div class="form-row">
    <input id="offerTitle" placeholder="Offer Title">
    <input id="offerDisc" type="number" placeholder="Discount %">
  </div>
  <div class="form-group">
    <label>Offer Image (Optional)</label>
    <input id="offerPhoto" type="file" accept="image/*">
    <img id="offerPhotoPreview" class="photo-preview hidden" src="" alt="Offer Preview">
  </div>
  <button class="action" onclick="addOffer()">Add New Offer</button>
  
  <h3>Offer List (Scrollable Feed)</h3>
  <div id="offerFeed" class="scrollable-feed">
    </div>
</section>

<section id="billing">
  <h2>Create New Bill üßæ</h2>
  <div class="form-row">
    <input id="billCustName" placeholder="Customer Name">
    <input id="billCustPhone" placeholder="Customer Phone (for WhatsApp)">
  </div>
  <div class="form-row">
    <select id="billProd"></select>
    <input id="billQty" type="number" value="1" min="1" placeholder="Quantity">
  </div>
  <button class="action" onclick="addBillItem()">Add Item to Bill</button>
  <div id="billReceipt">
    <h3 style="border-bottom: 1px dotted #ccc;">SALON BILL RECEIPT - ${new Date().toLocaleDateString()}</h3>
    <table id="billTable">
      <tr><th>Product</th><th>Qty</th><th>Price</th><th>Total</th></tr>
    </table>
    <h3 style="text-align: right; border-top: 1px dotted #ccc; padding-top: 5px;">
      NET TOTAL: <span id="billTotal" style="color:var(--primary-blue);">0.00</span>
    </h3>
  </div>
  <button class="action" onclick="saveBill()">Finalize & Save Bill</button>
</section>

<section id="sales">
  <h2>Sales Report üìà</h2>
  <h3 style="color: var(--primary-blue);">
    Current Month/Day Sales: <span id="totalSales">0.00</span>
  </h3>
  <button class="action" onclick="closeDay()" style="background: var(--success-green);">Close Day & Reset Sales</button>
  <button class="action" onclick="generatePDFStatement()">Generate Monthly Sales PDF</button>

  <h2 style="margin-top: 30px;">Monthly Sales History üí∞</h2>
  <table id="monthlySalesTable">
      <tr><th>Date</th><th>Sales Amount</th></tr>
  </table>
</section>

<section id="history">
  <h2>Customer List üßë‚Äçü§ù‚Äçüßë</h2>
  <div id="customerList">
    </div>

  <h2 style="margin-top: 30px;">Transaction History üìú</h2>
  <table id="histTable">
    <tr><th>Customer</th><th>Phone</th><th>Total Bill</th><th>Date</th></tr>
  </table>
</section>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove } 
    from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } 
    from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js"; 

  // --- Firebase Config (Please replace with your actual keys if needed) ---
  const firebaseConfig = {
    apiKey: "AIzaSyBBFGIwiuzXNFrJ7kRe1rNauKqolIVMVI4",
    authDomain: "upsm-107f6.firebaseapp.com",
    projectId: "upsm-107f6",
    storageBucket: "upsm-107f6.firebasestorage.app", 
    messagingSenderId: "359645965485",
    appId: "1:359645965485:web:a8358f7316cc433b182a24",
    measurementId: "G-QYS5PB1C6Y"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app); 

  let currentUser = localStorage.getItem("currentUser") || null;
  let currentUserData = {};
  let billItems = [];

  // DOM Elements
  const $ = (id) => document.getElementById(id);
  const navEl = $('mainNav');
  const { jsPDF } = window.jspdf;

  // --- Core Functions ---
  async function loadDashboardData() {
    if (!currentUser) return;
    const snap = await getDoc(doc(db, "users", currentUser));
    if (!snap.exists()) return;
    
    currentUserData = snap.data();
    
    renderAppointments(currentUserData.appointments || []);
    renderProducts(currentUserData.products || []);
    renderOffers(currentUserData.offers || []);
    renderHistory(currentUserData.history || []);
    renderMonthlySales(currentUserData.monthlySales || []); 
    
    $('totalSales').innerText = (currentUserData.totalSales || 0).toFixed(2);
  }

  // Navigation
  window.showTab = function(id, btn) {
    document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
    document.querySelectorAll("#mainNav button").forEach(b => b.classList.remove("active"));
    
    if (btn) btn.classList.add("active");
    
    $(id).classList.add("active");

    if (currentUser && ['appointments', 'products', 'offers', 'sales', 'history'].includes(id)) {
        loadDashboardData();
    }
    if (id === 'billing') {
        renderProducts(currentUserData.products || []);
    }
  }

  // Initial check
  if (currentUser) {
    navEl.classList.remove('hidden'); 
    window.showTab('appointments', document.querySelector("nav button:nth-child(1)"));
    loadDashboardData();
  } else {
    navEl.classList.add('hidden'); 
    window.showTab('auth', document.querySelector("#auth"));
    window.showLogin(); 
  }
  
  // --- Auth & Session ---
  window.showLogin = function() {
    $('loginForm').classList.remove('hidden');
    $('registerForm').classList.add('hidden');
    $('forgotForm').classList.add('hidden');
  }

  window.showRegister = function() {
    $('loginForm').classList.add('hidden');
    $('registerForm').classList.remove('hidden');
    $('forgotForm').classList.add('hidden');
  }

  window.showForgot = function() {
    $('loginForm').classList.add('hidden');
    $('registerForm').classList.add('hidden');
    $('forgotForm').classList.remove('hidden');
  }

  window.registerUser = async function() {
    let u = $('regUser').value.trim(), p = $('regPass').value, pin = $('regPin').value.trim();
    if (!u || !p || !pin) return alert("Please fill all fields (Username, Password, Owner Pin).");
    const snap = await getDoc(doc(db, "users", u));
    if (snap.exists()) return alert("This Username already exists.");
    await setDoc(doc(db, "users", u), { 
        password: p, 
        pin: pin, 
        appointments:[], products:[], bills:[], offers:[], totalSales:0, history:[], monthlySales:[]
    });
    alert("Account created successfully! Please Login now.");
    $('regUser').value = $('regPass').value = $('regPin').value = '';
    window.showLogin(); 
  }

  window.loginUser = async function() {
    let u = $('logUser').value.trim(), p = $('logPass').value;
    const snap = await getDoc(doc(db, "users", u));
    
    if(snap.exists() && snap.data().password === p){ 
        currentUser = u; 
        localStorage.setItem("currentUser", u);
        alert("Welcome, "+u+"! Loading Dashboard..."); 
        
        navEl.classList.remove('hidden'); 
        window.showTab('appointments', document.querySelector("nav button:nth-child(1)"));
        loadDashboardData();
    }
    else alert("Invalid username or password.");
  }

  window.logoutUser = function() {
      currentUser = null;
      localStorage.removeItem("currentUser");
      currentUserData = {};
      alert("Logged out successfully.");
      
      navEl.classList.add('hidden'); 
      window.showTab('auth', document.querySelector("#auth"));
      window.showLogin(); 
      
      document.querySelectorAll("table").forEach(t => t.innerHTML = '<tr><th>Header</th></tr>');
      $('billTotal').innerText="0.00";
      $('totalSales').innerText="0.00";
  }

  window.forgotPassword = async function(){
    let u = $('fpUser').value.trim(), pin = $('fpPin').value.trim();
    const snap = await getDoc(doc(db,"users",u));
    if(snap.exists() && snap.data().pin === pin) alert("Your Password is: "+snap.data().password);
    else alert("Wrong username or Owner Pin!");
  }
  
  // --- Pin Verification ---
  async function verifyOwnerPin() {
    if (!currentUser) return false;
    const inputPin = prompt("Enter Owner Pin to confirm this action:");
    if (!inputPin) return false;
    
    const snap = await getDoc(doc(db,"users",currentUser));
    if(snap.exists() && snap.data().pin === inputPin) {
        return true;
    } else {
        alert("Invalid Owner Pin!");
        return false;
    }
  }

  // --- Rendering Functions ---
  async function uploadPhoto(file, path) {
    if (!file) return null;
    const storageRef = ref(storage, `${currentUser}/${path}/${new Date().getTime()}_${file.name}`);
    const snapshot = await uploadBytes(storageRef, file);
    return getDownloadURL(snapshot.ref);
  }

  // Rendering for Products
  function renderProducts(prods) {
      const feed = $('prodFeed');
      feed.innerHTML = ''; 
      const billSelect = $('billProd');
      billSelect.innerHTML = '<option value="">--- Select Item ---</option>';
      
      prods.forEach(prod => {
          const card = document.createElement('div');
          card.className = 'feed-card';
          card.innerHTML = `
              <img src="${prod.photoURL || 'https://via.placeholder.com/80?text=No+Photo'}" class="feed-image" alt="${prod.name}">
              <div class="feed-content">
                  <strong>${prod.name}</strong><br>
                  Price: <span style="color:var(--primary-blue);">Rs. ${prod.price.toFixed(2)}</span>
              </div>
              <div class="feed-actions">
                  <button class="row-actions action" style="background:var(--danger-red);" onclick="removeProduct('${prod.name}')">Remove</button>
              </div>
          `;
          feed.appendChild(card);

          let opt = document.createElement("option");
          opt.value = `${prod.name}|${prod.price}`; 
          opt.text = `${prod.name} (Rs. ${prod.price.toFixed(2)})`;
          billSelect.add(opt);
      });
  }

  // Rendering for Offers
  function renderOffers(offers) {
      const feed = $('offerFeed');
      feed.innerHTML = ''; 
      
      offers.forEach(offer => {
          const card = document.createElement('div');
          card.className = 'feed-card';
          card.innerHTML = `
              <img id="offerImage-${offer.title.replace(/\s/g, '-')}" src="${offer.photoURL || 'https://via.placeholder.com/80?text=Offer'}" class="feed-image" alt="${offer.title}">
              <div class="feed-content">
                  <strong>${offer.title}</strong><br>
                  Discount: <span style="color:var(--primary-blue);">${offer.discount}% OFF</span>
              </div>
              <div class="feed-actions">
                  <button class="row-actions share-btn" onclick="shareOfferPopup('${offer.title}', '${offer.discount}', '${offer.photoURL || 'https://via.placeholder.com/80?text=Offer'}')">Share</button>
                  <button class="row-actions action" style="background:var(--danger-red);" onclick="removeOffer('${offer.title}')">Remove</button>
              </div>
          `;
          feed.appendChild(card);
      });
  }

  // --- Rendering Appointments (Updated with Status and Delete) ---
  function renderAppointments(apts) {
      const initialHTML = `<tr><th>Customer</th><th>Service</th><th>Date</th><th>Time</th><th>Status</th><th>Delete</th></tr>`;
      const table = $('apptTable');
      table.innerHTML = initialHTML;

      apts.forEach(appt => {
          const row = table.insertRow(-1);
          // Create a unique ID for the delete button using date and time
          const deleteBtnId = `del-${appt.date}-${appt.time}`.replace(/[:-\s]/g, '');

          // Determine the correct status (use 'Pending' if not set)
          const currentStatus = appt.status || 'Pending'; 

          row.innerHTML = `
              <td>${appt.customer}</td>
              <td>${appt.service}</td>
              <td>${appt.date}</td>
              <td>${appt.time}</td>
              <td>
                  <select class="status-select" 
                          id="status-${deleteBtnId}"
                          onchange="manageAppointment('${appt.date}', '${appt.time}', this.value)">
                      <option value="Pending" ${currentStatus === 'Pending' ? 'selected' : ''}>Pending</option>
                      <option value="Finished" ${currentStatus === 'Finished' ? 'selected' : ''}>Finished</option>
                      <option value="Cancelled" ${currentStatus === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                  </select>
              </td>
              <td>
                  <button class="delete-btn" 
                          id="${deleteBtnId}"
                          style="display: ${['Finished', 'Cancelled'].includes(currentStatus) ? 'block' : 'none'};"
                          onclick="deleteAppointment('${appt.date}', '${appt.time}')">Delete</button>
              </td>
          `;
      });
  }

  // General Table Renderer
  function renderTable(tableId, data, rowRenderer, initialHTML) {
      const table = $(tableId);
      table.innerHTML = initialHTML;
      data.forEach(item => {
          const row = table.insertRow(-1);
          row.innerHTML = rowRenderer(item);
      });
  }

  // Rendering for Monthly Sales
  function renderMonthlySales(salesData) { 
      const initialHTML = `<tr><th>Date</th><th>Sales Amount</th></tr>`;
      renderTable('monthlySalesTable', salesData, (sale) => 
          `<td>${sale.date}</td><td>${sale.amount.toFixed(2)}</td>`
      , initialHTML);
  }

  // Rendering for History and Customer List
  function renderHistory(history) {
      const histInitialHTML = `<tr><th>Customer</th><th>Phone</th><th>Total Bill</th><th>Date</th></tr>`;
      renderTable('histTable', history, (bill) => 
          `<td>${bill.customer || 'N/A'}</td><td>${bill.phone || 'N/A'}</td><td>${bill.total.toFixed(2)}</td><td>${bill.date}</td>`
      , histInitialHTML);

      const customerMap = {};
      history.forEach(bill => {
          if (bill.phone) {
              const name = bill.customer || 'N/A';
              const phone = bill.phone;
              if (!customerMap[phone]) {
                  customerMap[phone] = { name: name, phone: phone, lastVisit: bill.date, totalSpent: 0 };
              }
              customerMap[phone].totalSpent += bill.total;
              if (new Date(bill.date) > new Date(customerMap[phone].lastVisit)) {
                  customerMap[phone].lastVisit = bill.date;
              }
          }
      });
      
      const customerListDiv = $('customerList');
      customerListDiv.innerHTML = '';
      const sortedCustomers = Object.values(customerMap).sort((a,b) => new Date(b.lastVisit) - new Date(a.lastVisit));
      
      if (sortedCustomers.length === 0) {
        customerListDiv.innerHTML = '<p style="text-align:center; color:#606770;">No customer data saved yet.</p>';
      } else {
        sortedCustomers.forEach(cust => {
            const item = document.createElement('div');
            item.className = 'customer-item';
            item.innerHTML = `
                <div>
                    <span style="color:var(--primary-blue);">${cust.name}</span> <span style="font-size:12px; color:#606770;">(${cust.phone})</span><br>
                    <small>Last Visit: ${new Date(cust.lastVisit).toLocaleDateString()}</small>
                </div>
                <div>
                    Total Spent: <span style="color:var(--primary-blue); font-size: 16px;">Rs. ${cust.totalSpent.toFixed(2)}</span>
                </div>
            `;
            customerListDiv.appendChild(item);
        });
      }
  }


  // --- Data Management Functions ---
  
  // Appointment Management (New)
  window.manageAppointment = async function(date, time, newStatus) {
      if (!currentUser) return;

      const appointments = currentUserData.appointments || [];
      const index = appointments.findIndex(a => a.date === date && a.time === time);
      
      if (index === -1) {
          alert("Appointment not found in database.");
          loadDashboardData();
          return;
      }
      
      const apptToUpdate = { ...appointments[index], status: newStatus };
      
      const newAppointments = appointments.filter((_, i) => i !== index);
      newAppointments.push(apptToUpdate);

      await updateDoc(doc(db, "users", currentUser), { appointments: newAppointments });

      // Update the UI element (Delete button visibility)
      const deleteBtnId = `del-${date}-${time}`.replace(/[:-\s]/g, '');
      const deleteBtn = $(deleteBtnId);

      if (deleteBtn) {
          if (newStatus === 'Finished' || newStatus === 'Cancelled') {
              deleteBtn.style.display = 'block';
          } else {
              deleteBtn.style.display = 'none';
          }
      }
      
      alert(`Appointment status updated to: ${newStatus}`);
      currentUserData.appointments = newAppointments;
  }
  
  // Delete Appointment (Updated to be called separately)
  window.deleteAppointment = async function(date, time) {
      if (!currentUser) return;
      if (!await verifyOwnerPin()) return; // Pin Check
      
      const apptToRemove = currentUserData.appointments.find(a => a.date === date && a.time === time);
      if (apptToRemove) {
          await updateDoc(doc(db, "users", currentUser), { appointments: arrayRemove(apptToRemove) });
          alert("Appointment deleted permanently.");
          loadDashboardData();
      }
  }


  // Product/Offer Removal (Pin Protected)
  window.removeProduct = async function(name) {
      if (!currentUser) return;
      if (!await verifyOwnerPin()) return; 
      
      const prodToRemove = currentUserData.products.find(p => p.name === name);
      if (prodToRemove) {
          await updateDoc(doc(db, "users", currentUser), { products: arrayRemove(prodToRemove) });
          alert("Product/Service removed.");
          loadDashboardData();
      }
  }
  
  window.removeOffer = async function(title) {
      if (!currentUser) return;
      if (!await verifyOwnerPin()) return; 
      
      const offerToRemove = currentUserData.offers.find(o => o.title === title);
      if (offerToRemove) {
          await updateDoc(doc(db, "users", currentUser), { offers: arrayRemove(offerToRemove) });
          alert("Offer removed.");
          loadDashboardData();
      }
  }

  // Adding Data
  window.addAppointment = async function(){
    if(!currentUser) return alert("Please log in first.");
    let appt = { 
        customer:$('custName').value.trim(), 
        service:$('service').value.trim(), 
        date:$('apptDate').value, 
        time:$('apptTime').value,
        status: 'Pending' // Set default status
    };
    if (!appt.customer || !appt.service || !appt.date || !appt.time) return alert("Please fill all appointment details.");
    
    await updateDoc(doc(db,"users",currentUser), { appointments: arrayUnion(appt) });
    alert("Appointment added.");
    $('custName').value = $('service').value = $('apptDate').value = $('apptTime').value = '';
    loadDashboardData(); 
  }

  window.addProduct = async function(){
    if(!currentUser) return alert("Please log in first.");
    let name = $('prodName').value.trim();
    let price = +$('prodPrice').value;
    const photoFile = $('prodPhoto').files[0];
    
    if (!name || isNaN(price) || price <= 0) return alert("Invalid Name or Price.");

    let photoURL = null;
    if (photoFile) {
        alert("Image is uploading, please wait...");
        try {
            photoURL = await uploadPhoto(photoFile, 'products');
        } catch (e) {
            alert("Image upload failed: " + e.message);
            return;
        }
    }
    
    let prod = { name, price, photoURL };
    
    await updateDoc(doc(db,"users",currentUser), { products: arrayUnion(prod) });
    alert("Product/Service added successfully.");
    $('prodName').value = $('prodPrice').value = '';
    $('prodPhoto').value = null; 
    loadDashboardData(); 
  }
  
  window.addOffer = async function(){
    if(!currentUser) return alert("Please log in first.");
    let title = $('offerTitle').value.trim();
    let discount = +$('offerDisc').value;
    const photoFile = $('offerPhoto').files[0];

    if (!title || isNaN(discount) || discount <= 0 || discount >= 100) return alert("Invalid Title or Discount (must be between 1 and 99).");

    let photoURL = null;
    if (photoFile) {
        alert("Image is uploading, please wait...");
        try {
            photoURL = await uploadPhoto(photoFile, 'offers');
        } catch (e) {
            alert("Image upload failed: " + e.message);
            return;
        }
    }

    let offer = { title, discount, photoURL };
    await updateDoc(doc(db,"users",currentUser), { offers: arrayUnion(offer) });
    alert("Offer added successfully.");
    $('offerTitle').value = $('offerDisc').value = '';
    $('offerPhoto').value = null; 
    loadDashboardData();
  }

  window.addBillItem = function(){
    let prodValue = $('billProd').value;
    let qty = +$('billQty').value;
    if(!prodValue || qty<=0) return alert("Please select an item and enter a valid quantity.");
    
    let [name, priceStr] = prodValue.split("|");
    let price = +priceStr;
    let total = qty * price;
    
    billItems.push({name, qty, price, total});
    
    const table = $('billTable');
    const row = table.insertRow(-1);
    row.innerHTML = `<td>${name}</td><td style="text-align:center;">${qty}</td><td style="text-align:right;">${price.toFixed(2)}</td><td style="text-align:right;">${total.toFixed(2)}</td>`;
    
    $('billTotal').innerText = billItems.reduce((s,i)=>s+i.total,0).toFixed(2);
    $('billQty').value = 1;
    $('billProd').value = '';
  }

  window.saveBill = async function(){
    if(!currentUser) return alert("Please log in first.");
    if(billItems.length === 0) return alert("The bill is empty.");
    
    const finalTotal = billItems.reduce((s,i)=>s+i.total, 0);
    
    const customerName = $('billCustName').value.trim() || "Walk-in Customer";
    const customerPhone = $('billCustPhone').value.trim(); 
    const cleanPhone = customerPhone ? customerPhone.replace(/[^0-9]/g, "") : null;
    
    let bill = { 
        customer: customerName,
        phone: cleanPhone, 
        items: billItems, 
        total: finalTotal, 
        date: new Date().toLocaleString() 
    };

    const newTotalSales = (currentUserData.totalSales || 0) + finalTotal;

    // 1. Generate Image Receipt using html2canvas
    try {
        const receiptEl = $('billReceipt');
        
        const canvas = await html2canvas(receiptEl, { 
            scale: 2, 
            logging: false,
            removeContainer: true 
        });
        
        const imgData = canvas.toDataURL('image/png');
        
        const newWindow = window.open();
        newWindow.document.write('<html><head><title>Bill Receipt for ' + customerName + '</title></head><body style="margin:0; text-align:center;"><h1>Bill Image (Right Click to Save)</h1><img src="' + imgData + '" style="max-width:400px; border:1px solid black;"/></body></html>');
        
        alert(`Bill of Rs. ${finalTotal.toFixed(2)} saved and Image Receipt generated!`);
        
    } catch(error) {
        console.error("Error generating receipt image:", error);
        alert("Bill saved, but failed to generate image receipt. Check console for details.");
    }
    
    // 2. Save Data to Firebase
    await updateDoc(doc(db,"users",currentUser), { 
        bills: arrayUnion(bill), 
        history: arrayUnion(bill), 
        totalSales: newTotalSales 
    });

    // 3. Optional WhatsApp Text Receipt
    if (cleanPhone && cleanPhone.length >= 10) {
        let msgText = `*Salon Receipt - ${currentUser}*\n\n`;
        msgText += `Dear ${customerName},\n`;
        msgText += `Your Total: *Rs. ${finalTotal.toFixed(2)}*\n`;
        msgText += `Date: ${new Date().toLocaleDateString()}\n\n`;
        
        const encodedMessage = encodeURIComponent(msgText);
        const waLink = `https://wa.me/${cleanPhone}?text=${encodedMessage}`;
        
        window.open(waLink, '_blank');
    }

    // 4. Reset Bill State
    billItems = []; 
    $('billTable').innerHTML="<tr><th>Product</th><th>Qty</th><th>Price</th><th>Total</th></tr>";
    $('billTotal').innerText="0.00";
    $('billCustName').value = '';
    $('billCustPhone').value = '';
    
    loadDashboardData();
  }
  
  // Sales & Reporting Functions
  window.closeDay = async function() {
    if (!currentUser) return alert("Please log in first.");
    if (!await verifyOwnerPin()) return; 

    const currentSales = currentUserData.totalSales || 0;
    if (currentSales === 0) return alert("No sales to close for today/this period.");

    const confirmation = confirm(`Are you sure you want to close the day/period? Sales amount Rs. ${currentSales.toFixed(2)} will be archived and the current total will be reset to 0.`);
    if (!confirmation) return;
    
    const salesRecord = {
        date: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }),
        amount: currentSales
    };

    await updateDoc(doc(db,"users",currentUser), { 
        monthlySales: arrayUnion(salesRecord),
        totalSales: 0 
    });
    
    alert(`Day closed successfully! Sales of Rs. ${currentSales.toFixed(2)} archived.`);
    loadDashboardData();
  }

  window.generatePDFStatement = function() {
      if (!currentUser) return alert("Please log in first.");
      const salesData = currentUserData.monthlySales || [];
      if (salesData.length === 0) return alert("No sales data in history to generate PDF.");

      const doc = new jsPDF();
      const shopName = `SALON MANAGER PRO - ${currentUser.toUpperCase()}`;
      const title = "Monthly Sales Statement";
      
      doc.setFontSize(18);
      doc.text(shopName, 105, 20, null, null, "center");
      doc.setFontSize(14);
      doc.text(title, 105, 30, null, null, "center");
      doc.setFontSize(10);
      doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 36, null, null, "center");

      const tableColumn = ["Date", "Sales Amount (Rs.)"];
      const tableRows = [];
      let grandTotal = 0;

      salesData.forEach(sale => {
          tableRows.push([
              sale.date,
              sale.amount.toFixed(2)
          ]);
          grandTotal += sale.amount;
      });

      doc.autoTable(tableColumn, tableRows, { startY: 45 });
      
      const finalY = doc.autoTable.previous.finalY;
      doc.setFontSize(12);
      doc.setFont(doc.getFont().fontName, 'bold');
      doc.text(`GRAND TOTAL: Rs. ${grandTotal.toFixed(2)}`, 190, finalY + 10, null, null, "right");

      doc.save(`Sales_Statement_${currentUser}_${new Date().getMonth() + 1}_${new Date().getFullYear()}.pdf`);
      alert("PDF Statement generated and downloaded.");
  }
  
  // Offer Sharing Function
  window.shareOfferPopup = function(title, discount, photoURL) {
      const shareText = `*New Offer at ${currentUser}'s Salon!* üî•\n\nüéâ ${title}\nDiscount: *${discount}% OFF* on selected services!\n\nVisit us today!`;
      
      const shareOption = prompt(
          `Share Offer: ${title}\n\nSelect an option:\n1. Share via WhatsApp\n2. Share via Facebook/Instagram (Copy Text)\n3. Download Offer Image`
      );

      if (!shareOption) return; 

      switch(shareOption.trim()) {
          case '1': 
              const waLink = `https://wa.me/?text=${encodeURIComponent(shareText + "\n\n(View offer image here: " + photoURL + ")")}`;
              window.open(waLink, '_blank');
              break;
          case '2': 
              navigator.clipboard.writeText(shareText)
                  .then(() => {
                      alert("Offer text copied to clipboard! You can now paste it on Facebook, Instagram, or any other social media platform.");
                  })
                  .catch(err => {
                      console.error('Could not copy text: ', err);
                      alert("Failed to copy text. Please manually copy the following:\n\n" + shareText);
                  });
              break;
          case '3': 
              if (photoURL && !photoURL.includes('placeholder')) {
                  const link = document.createElement('a');
                  link.href = photoURL;
                  link.download = `${title.replace(/\s/g, '_')}_Offer.png`;
                  document.body.appendChild(link);
                  link.click();
                  document.body.removeChild(link);
                  alert("Image download started.");
              } else {
                  alert("No custom image available to download.");
              }
              break;
          default:
              alert("Invalid option selected.");
      }
  };

</script>
</body>
</html>
